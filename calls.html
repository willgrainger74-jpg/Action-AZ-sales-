<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Calls - Action Plumbing</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .calendar-day {
            transition: all 0.3s ease;
        }
        .calendar-day:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }
        .call-card {
            transition: all 0.2s ease;
        }
        .call-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-green-50 min-h-screen">
    <div class="p-6" style="max-width: 1400px; margin: 0 auto;">
        <!-- Header -->
        <div class="bg-gradient-to-r from-green-600 via-emerald-600 to-teal-700 text-white p-6 rounded-2xl shadow-2xl mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-black mb-1">üìû Log Calls</h1>
                    <p class="text-lg opacity-90" id="personName"></p>
                </div>
                <a href="index.html" class="px-6 py-3 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-xl font-bold transition-all backdrop-blur-sm">
                    ‚Üê Back to Dashboard
                </a>
            </div>
        </div>

        <!-- Calendar Widget -->
        <div class="bg-white p-6 rounded-2xl shadow-xl mb-6">
            <div class="flex items-center justify-between mb-6">
                <button id="prevWeek" class="p-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl hover:from-blue-600 hover:to-indigo-700 font-bold text-2xl shadow-lg transition-all">‚Üê</button>
                <h2 id="weekRange" class="text-2xl font-bold text-gray-800"></h2>
                <button id="nextWeek" class="p-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl hover:from-blue-600 hover:to-indigo-700 font-bold text-2xl shadow-lg transition-all">‚Üí</button>
            </div>
            <div id="calendarContainer"></div>
        </div>

        <!-- Call Logs Section -->
        <div id="callsSection" style="display: none;" class="bg-white p-6 rounded-2xl shadow-xl">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-3xl font-bold text-gray-800">Call Logs</h3>
                <button id="addCallBtn" class="px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl hover:from-green-600 hover:to-emerald-700 font-bold shadow-lg transition-all">
                    + Add Call
                </button>
            </div>
            <div id="callsList" class="space-y-4 max-h-[800px] overflow-y-auto"></div>
        </div>
    </div>

    <script>
        firebase.initializeApp({
            apiKey: "AIzaSyD9POKxbl9hSt2FNtzdv3RPVnAb0wWsNbU",
            authDomain: "action-sales-tracker.firebaseapp.com",
            databaseURL: "https://action-sales-tracker-default-rtdb.firebaseio.com",
            projectId: "action-sales-tracker",
            storageBucket: "action-sales-tracker.firebasestorage.app",
            messagingSenderId: "686455834332",
            appId: "1:686455834332:web:84e9b843f912522bbdd619"
        });

        const db = firebase.database();
        const selected = localStorage.getItem('selectedPerson');
        let currentDate = new Date();
        let selectedDate = null;
        let people = [];

        if (!selected) {
            window.location.href = 'index.html';
        }

        db.ref('salespeople').on('value', snapshot => {
            const data = snapshot.val();
            people = data ? Object.keys(data).map(k => ({ id: k, name: data[k].name })) : [];
            const person = people.find(p => p.id === selected);
            if (person) {
                document.getElementById('personName').textContent = `Logging calls for: ${person.name}`;
            }
        });

        const dk = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        const dataKey = d => `${selected}_${dk(d)}`;

        function getWeek(date) {
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(date);
            monday.setDate(diff);
            const week = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(monday);
                d.setDate(monday.getDate() + i);
                week.push(d);
            }
            return week;
        }

        function renderCalendar() {
            const week = getWeek(currentDate);
            document.getElementById('weekRange').textContent = 
                `${week[0].toLocaleDateString('en-US', {month:'short',day:'numeric'})} - ${week[6].toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'})}`;

            const container = document.getElementById('calendarContainer');
            container.innerHTML = `
                <div class="grid grid-cols-7 gap-3 mb-3">
                    ${['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].map(day => 
                        `<div class="text-center text-sm font-bold text-gray-600">${day}</div>`
                    ).join('')}
                </div>
                <div id="calendarDays" class="grid grid-cols-7 gap-3"></div>
            `;
            
            const daysContainer = document.getElementById('calendarDays');
            
            week.forEach((d, idx) => {
                db.ref(`callLogs/${dataKey(d)}`).once('value', snapshot => {
                    const calls = snapshot.val();
                    const callsArray = calls ? Object.values(calls) : [];
                    const sold = callsArray.filter(c => c.jobSold);
                    const total = callsArray.reduce((sum, c) => sum + (parseFloat(c.amountSold) || 0), 0);
                    const dateKey = dk(d);
                    const isToday = dk(new Date()) === dateKey;
                    const isSelected = selectedDate === dateKey;

                    const dayDiv = document.createElement('button');
                    dayDiv.className = `calendar-day p-4 rounded-xl border-2 ${
                        isSelected ? 'border-blue-600 bg-gradient-to-br from-blue-100 to-indigo-100 shadow-xl' :
                        callsArray.length > 0 ? 'border-green-400 bg-gradient-to-br from-green-50 to-emerald-50 hover:shadow-lg' :
                        isToday ? 'border-blue-300 bg-white shadow-md' :
                        'border-gray-200 bg-white hover:border-gray-300'
                    }`;
                    dayDiv.onclick = () => {
                        selectedDate = isSelected ? null : dateKey;
                        renderCalendar();
                        if (selectedDate) renderCalls(d);
                        else document.getElementById('callsSection').style.display = 'none';
                    };

                    dayDiv.innerHTML = `
                        <div class="text-2xl font-black text-gray-800">${d.getDate()}</div>
                        ${callsArray.length > 0 ? `
                            <div class="mt-2 space-y-1">
                                <div class="text-xs font-bold text-green-700">${sold.length} sold</div>
                                <div class="text-xs font-bold text-green-700">$${total.toLocaleString()}</div>
                            </div>
                        ` : '<div class="text-xs text-gray-400 mt-2">No calls</div>'}
                    `;
                    daysContainer.appendChild(dayDiv);
                });
            });
        }

        function calculateMoneyOwed(amountSold, amountCollected) {
            const sold = parseFloat(amountSold) || 0;
            const collected = parseFloat(amountCollected) || 0;
            return Math.max(0, sold - collected);
        }

        function renderCalls(date) {
            document.getElementById('callsSection').style.display = 'block';
            const key = dataKey(date);

            db.ref(`callLogs/${key}`).on('value', snapshot => {
                const calls = snapshot.val();
                const callsArray = calls ? Object.keys(calls).map(id => ({ id, ...calls[id] })) : [];

                const container = document.getElementById('callsList');
                if (callsArray.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 py-12 text-lg">No calls logged for this day</p>';
                } else {
                    container.innerHTML = callsArray.map(call => `
                        <div class="call-card p-6 bg-gradient-to-br from-gray-50 to-blue-50 rounded-xl border-2 border-gray-200">
                            <div class="flex justify-between mb-4">
                                <span class="text-sm font-bold text-gray-600 bg-white px-3 py-1 rounded-full">Call Entry</span>
                                <button onclick="deleteCall('${call.id}')" class="text-red-600 font-bold hover:text-red-800 bg-red-50 px-4 py-1 rounded-full transition-all hover:bg-red-100">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                            <div class="space-y-4">
                                <input type="text" value="${call.customerName || ''}" onchange="updateCall('${call.id}', 'customerName', this.value)" class="w-full px-4 py-3 border-2 rounded-xl font-semibold text-lg focus:border-blue-500 focus:outline-none" placeholder="Customer Name" />
                                <input type="text" value="${call.jobNumber || ''}" onchange="updateCall('${call.id}', 'jobNumber', this.value)" class="w-full px-4 py-3 border-2 rounded-xl focus:border-blue-500 focus:outline-none" placeholder="Job Number" />
                                <input type="tel" value="${call.customerPhone || ''}" onchange="updateCall('${call.id}', 'customerPhone', this.value)" class="w-full px-4 py-3 border-2 rounded-xl focus:border-blue-500 focus:outline-none" placeholder="Customer Phone" />
                                
                                <label class="flex items-center gap-3 p-4 bg-white rounded-xl border-2 border-gray-300 cursor-pointer hover:border-green-400 transition-all">
                                    <input type="checkbox" ${call.jobSold ? 'checked' : ''} onchange="updateCall('${call.id}', 'jobSold', this.checked)" class="w-6 h-6" />
                                    <span class="font-bold text-xl">üí∞ Job Sold</span>
                                </label>
                                
                                ${call.jobSold ? `
                                    <div class="space-y-3 p-4 bg-green-50 rounded-xl border-2 border-green-300">
                                        <div>
                                            <label class="text-sm font-bold text-gray-700 block mb-1">Total Amount Sold ($)</label>
                                            <input id="amountSold_${call.id}" type="number" value="${call.amountSold || ''}" onchange="handleAmountChange('${call.id}')" class="w-full px-4 py-3 border-2 border-green-400 rounded-xl text-xl font-bold focus:outline-none focus:border-green-500" placeholder="0.00" />
                                        </div>
                                        <div>
                                            <label class="text-sm font-bold text-gray-700 block mb-1">Amount Collected ($)</label>
                                            <input id="amountCollected_${call.id}" type="number" value="${call.amountCollected || ''}" onchange="handleAmountChange('${call.id}')" class="w-full px-4 py-3 border-2 border-blue-400 rounded-xl text-xl font-bold focus:outline-none focus:border-blue-500" placeholder="0.00" />
                                        </div>
                                        <div class="p-4 bg-gradient-to-r from-orange-100 to-red-100 rounded-xl border-2 border-orange-400">
                                            <label class="text-sm font-bold text-orange-800 block mb-1">üíµ Money Still Owed</label>
                                            <p id="moneyOwed_${call.id}" class="text-3xl font-black text-orange-900">$${calculateMoneyOwed(call.amountSold, call.amountCollected).toLocaleString()}</p>
                                            <p class="text-xs text-gray-600 mt-1">Auto-calculated: Sold - Collected</p>
                                        </div>

                                        <!-- Sold from Turnover Section -->
                                        <div class="p-4 bg-purple-50 rounded-xl border-2 border-purple-300">
                                            <label class="flex items-center gap-3 cursor-pointer mb-3">
                                                <input type="checkbox" ${call.soldFromTurnover ? 'checked' : ''} onchange="updateCall('${call.id}', 'soldFromTurnover', this.checked)" class="w-5 h-5" />
                                                <span class="font-bold text-purple-900">üîÑ Sold from Turnover</span>
                                            </label>
                                            ${call.soldFromTurnover ? `
                                                <div>
                                                    <label class="text-sm font-bold text-gray-700 block mb-1">Turnover received from:</label>
                                                    <select onchange="updateCall('${call.id}', 'turnoverFrom', this.value)" class="w-full px-4 py-3 border-2 border-purple-400 rounded-xl focus:outline-none focus:border-purple-500">
                                                        <option value="">Select salesperson...</option>
                                                        ${people.filter(p => p.id !== selected).map(p => 
                                                            `<option value="${p.id}" ${call.turnoverFrom === p.id ? 'selected' : ''}>${p.name}</option>`
                                                        ).join('')}
                                                    </select>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                ` : ''}

                                <label class="flex items-center gap-3 p-4 bg-white rounded-xl border-2 border-gray-300 cursor-pointer hover:border-red-400 transition-all">
                                    <input type="checkbox" ${call.jobCancelled ? 'checked' : ''} onchange="updateCall('${call.id}', 'jobCancelled', this.checked)" class="w-6 h-6" />
                                    <span class="font-bold text-xl">‚ùå Job Cancelled</span>
                                </label>
                                
                                ${call.jobCancelled ? `
                                    <textarea onchange="updateCall('${call.id}', 'cancelReason', this.value)" class="w-full px-4 py-3 border-2 border-red-300 rounded-xl focus:outline-none focus:border-red-500" placeholder="Reason for cancellation..." rows="3">${call.cancelReason || ''}</textarea>
                                ` : ''}

                                <label class="flex items-center gap-3 p-4 bg-white rounded-xl border-2 border-gray-300 cursor-pointer hover:border-orange-400 transition-all">
                                    <input type="checkbox" ${call.leftEstimate ? 'checked' : ''} onchange="updateCall('${call.id}', 'leftEstimate', this.checked)" class="w-6 h-6" />
                                    <span class="font-bold text-lg">üìã Left Estimate</span>
                                </label>
                                
                                ${call.leftEstimate ? `
                                    <input type="number" value="${call.estimateAmount || ''}" onchange="updateCall('${call.id}', 'estimateAmount', parseFloat(this.value) || 0)" class="w-full px-4 py-3 border-2 border-orange-300 rounded-xl focus:outline-none focus:border-orange-500" placeholder="Estimate Amount ($)" />
                                ` : ''}

                                <div class="border-t-2 pt-4 mt-4">
                                    <p class="font-bold text-sm text-gray-700 mb-3">Trade Type</p>
                                    <div class="grid grid-cols-2 gap-2">
                                        <label class="flex items-center gap-2 p-3 bg-blue-50 rounded-xl border-2 border-blue-300 cursor-pointer hover:bg-blue-100 transition-all">
                                            <input type="checkbox" ${call.tradePlumbing ? 'checked' : ''} onchange="updateCall('${call.id}', 'tradePlumbing', this.checked)" class="w-5 h-5" />
                                            <span class="text-sm font-bold text-blue-700">üîß Plumbing</span>
                                        </label>
                                        <label class="flex items-center gap-2 p-3 bg-yellow-50 rounded-xl border-2 border-yellow-300 cursor-pointer hover:bg-yellow-100 transition-all">
                                            <input type="checkbox" ${call.tradeElectrical ? 'checked' : ''} onchange="updateCall('${call.id}', 'tradeElectrical', this.checked)" class="w-5 h-5" />
                                            <span class="text-sm font-bold text-yellow-700">‚ö° Electrical</span>
                                        </label>
                                        <label class="flex items-center gap-2 p-3 bg-red-50 rounded-xl border-2 border-red-300 cursor-pointer hover:bg-red-100 transition-all">
                                            <input type="checkbox" ${call.tradeHVAC ? 'checked' : ''} onchange="updateCall('${call.id}', 'tradeHVAC', this.checked)" class="w-5 h-5" />
                                            <span class="text-sm font-bold text-red-700">üå°Ô∏è HVAC</span>
                                        </label>
                                        <label class="flex items-center gap-2 p-3 bg-purple-50 rounded-xl border-2 border-purple-300 cursor-pointer hover:bg-purple-100 transition-all">
                                            <input type="checkbox" ${call.tradeCameras ? 'checked' : ''} onchange="updateCall('${call.id}', 'tradeCameras', this.checked)" class="w-5 h-5" />
                                            <span class="text-sm font-bold text-purple-700">üìπ Cameras</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="border-t-2 pt-4 mt-4">
                                    <p class="font-bold text-sm text-gray-700 mb-3">Performance Metrics</p>
                                    <div class="grid grid-cols-2 gap-2">
                                        <label class="flex items-center gap-2 text-sm cursor-pointer p-2 hover:bg-gray-100 rounded-lg transition-all">
                                            <input type="checkbox" ${call.reviewCompleted ? 'checked' : ''} onchange="updateCall('${call.id}', 'reviewCompleted', this.checked)" class="w-4 h-4" />
                                            <span>‚úÖ Review</span>
                                        </label>
                                        <label class="flex items-center gap-2 text-sm cursor-pointer p-2 hover:bg-gray-100 rounded-lg transition-all">
                                            <input type="checkbox" ${call.restorationLead ? 'checked' : ''} onchange="updateCall('${call.id}', 'restorationLead', this.checked)" class="w-4 h-4" />
                                            <span>üè† Restoration</span>
                                        </label>
                                        <label class="flex items-center gap-2 text-sm cursor-pointer p-2 hover:bg-gray-100 rounded-lg transition-all">
                                            <input type="checkbox" ${call.turnoverAttempted ? 'checked' : ''} onchange="updateCall('${call.id}', 'turnoverAttempted', this.checked)" class="w-4 h-4" />
                                            <span>üîÑ Turnover Attempt</span>
                                        </label>
                                        <label class="flex items-center gap-2 text-sm cursor-pointer p-2 hover:bg-gray-100 rounded-lg transition-all">
                                            <input type="checkbox" ${call.turnoverAccepted ? 'checked' : ''} onchange="updateCall('${call.id}', 'turnoverAccepted', this.checked)" ${!call.turnoverAttempted ? 'disabled' : ''} class="w-4 h-4" />
                                            <span>‚úîÔ∏è Turnover Accept</span>
                                        </label>
                                        <label class="flex items-center gap-2 text-sm cursor-pointer p-2 hover:bg-gray-100 rounded-lg transition-all">
                                            <input type="checkbox" ${call.threeDoorKnocks ? 'checked' : ''} onchange="updateCall('${call.id}', 'threeDoorKnocks', this.checked)" class="w-4 h-4" />
                                            <span>üö™ 3 Door Knocks</span>
                                        </label>
                                        <label class="flex items-center gap-2 text-sm cursor-pointer p-2 hover:bg-gray-100 rounded-lg transition-all">
                                            <input type="checkbox" ${call.membershipPlanSold ? 'checked' : ''} onchange="updateCall('${call.id}', 'membershipPlanSold', this.checked)" class="w-4 h-4" />
                                            <span>üõ°Ô∏è Membership Plan</span>
                                        </label>
                                        <label class="flex items-center gap-2 text-sm cursor-pointer p-2 hover:bg-gray-100 rounded-lg transition-all">
                                            <input type="checkbox" ${call.upsellCompleted ? 'checked' : ''} onchange="updateCall('${call.id}', 'upsellCompleted', this.checked)" class="w-4 h-4" />
                                            <span>‚¨ÜÔ∏è Upsell</span>
                                        </label>
                                        <label class="flex items-center gap-2 text-sm cursor-pointer p-2 hover:bg-gray-100 rounded-lg transition-all">
                                            <input type="checkbox" ${call.jobComplete ? 'checked' : ''} onchange="updateCall('${call.id}', 'jobComplete', this.checked)" class="w-4 h-4" />
                                            <span>‚úîÔ∏è Complete</span>
                                        </label>
                                    </div>
                                    ${call.upsellCompleted ? `
                                        <input type="number" value="${call.upsellAmount || ''}" onchange="updateCall('${call.id}', 'upsellAmount', parseFloat(this.value) || 0)" class="w-full px-4 py-3 border-2 rounded-xl mt-3 focus:outline-none focus:border-blue-500" placeholder="Upsell Amount ($)" />
                                    ` : ''}
                                </div>

                                <div class="border-t-2 pt-4 mt-4">
                                    <p class="font-bold text-sm text-gray-700 mb-2">üö´ Objection (if any)</p>
                                    <select onchange="updateCall('${call.id}', 'objection', this.value)" class="w-full px-4 py-3 border-2 rounded-xl focus:outline-none focus:border-blue-500">
                                        <option value="">No objection</option>
                                        <option value="price" ${call.objection === 'price' ? 'selected' : ''}>üí∞ Price too high</option>
                                        <option value="think" ${call.objection === 'think' ? 'selected' : ''}>ü§î Need to think about it</option>
                                        <option value="spouse" ${call.objection === 'spouse' ? 'selected' : ''}>üíë Need spouse approval</option>
                                        <option value="someone" ${call.objection === 'someone' ? 'selected' : ''}>üë∑ Already have someone</option>
                                        <option value="quotes" ${call.objection === 'quotes' ? 'selected' : ''}>üìã Want multiple quotes</option>
                                        <option value="timing" ${call.objection === 'timing' ? 'selected' : ''}>‚è∞ Not now / timing</option>
                                        <option value="trust" ${call.objection === 'trust' ? 'selected' : ''}>‚ö†Ô∏è Trust/Bad Reviews/Bad Experience</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            });

            document.getElementById('addCallBtn').onclick = () => {
                db.ref(`callLogs/${key}`).push().set({
                    customerName: '', jobNumber: '', customerPhone: '',
                    reviewCompleted: false, restorationLead: false,
                    turnoverAttempted: false, turnoverAccepted: false,
                    threeDoorKnocks: false, membershipPlanSold: false,
                    upsellCompleted: false, upsellAmount: 0, 
                    jobComplete: false, jobSold: false,
                    amountSold: 0, amountCollected: 0, moneyOwed: 0,
                    leftEstimate: false, estimateAmount: 0,
                    jobCancelled: false, cancelReason: '',
                    tradePlumbing: false, tradeHVAC: false,
                    tradeElectrical: false, tradeCameras: false,
                    objection: '',
                    soldFromTurnover: false, turnoverFrom: '',
                    timestamp: Date.now(), timeOfDay: new Date().getHours()
                });
            };
        }

        function handleAmountChange(callId) {
            const key = dataKey(getWeek(currentDate).find(d => dk(d) === selectedDate));
            const amountSold = parseFloat(document.getElementById(`amountSold_${callId}`).value) || 0;
            const amountCollected = parseFloat(document.getElementById(`amountCollected_${callId}`).value) || 0;
            const moneyOwed = calculateMoneyOwed(amountSold, amountCollected);

            db.ref(`callLogs/${key}/${callId}`).update({
                amountSold: amountSold,
                amountCollected: amountCollected,
                moneyOwed: moneyOwed
            });

            document.getElementById(`moneyOwed_${callId}`).textContent = `$${moneyOwed.toLocaleString()}`;
        }

        function updateCall(callId, field, value) {
            const key = dataKey(getWeek(currentDate).find(d => dk(d) === selectedDate));
            db.ref(`callLogs/${key}/${callId}/${field}`).set(value);
        }

        function deleteCall(callId) {
            if (confirm('Delete this call?')) {
                const key = dataKey(getWeek(currentDate).find(d => dk(d) === selectedDate));
                db.ref(`callLogs/${key}/${callId}`).remove();
            }
        }

        document.getElementById('prevWeek').onclick = () => {
            currentDate = new Date(currentDate.getTime() - 7*24*60*60*1000);
            selectedDate = null;
            document.getElementById('callsSection').style.display = 'none';
            renderCalendar();
        };

        document.getElementById('nextWeek').onclick = () => {
            currentDate = new Date(currentDate.getTime() + 7*24*60*60*1000);
            selectedDate = null;
            document.getElementById('callsSection').style.display = 'none';
            renderCalendar();
        };

        renderCalendar();
    </script>
</body>
</html>
