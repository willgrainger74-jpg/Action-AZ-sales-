<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Owed & Estimates - Action Plumbing</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .stat-card {
            transition: all 0.2s ease;
        }
        .stat-card:hover {
            transform: scale(1.05);
        }
        .item-card {
            transition: all 0.2s ease;
        }
        .item-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-orange-50 min-h-screen">
    <div class="p-6" style="max-width: 1400px; margin: 0 auto;">
        <!-- Header -->
        <div class="bg-gradient-to-r from-orange-600 via-red-600 to-pink-700 text-white p-6 rounded-2xl shadow-2xl mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-black mb-1">üí∞ Money Owed & Estimates</h1>
                    <p class="text-lg opacity-90" id="personName"></p>
                </div>
                <a href="index.html" class="px-6 py-3 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-xl font-bold transition-all backdrop-blur-sm">
                    ‚Üê Back to Dashboard
                </a>
            </div>
        </div>

        <!-- Summary Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Money Owed -->
            <div class="stat-card bg-gradient-to-br from-red-400 to-orange-600 text-white p-6 rounded-2xl shadow-xl">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-sm font-semibold opacity-90">üí∏ Total Money Owed</p>
                    <div class="text-4xl opacity-30">üí∏</div>
                </div>
                <p id="totalOwed" class="text-5xl font-black">$0</p>
                <p id="totalOwedJobs" class="text-sm opacity-75 mt-2">0 jobs</p>
            </div>

            <!-- Month Money Owed -->
            <div class="stat-card bg-gradient-to-br from-orange-400 to-yellow-600 text-white p-6 rounded-2xl shadow-xl">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-sm font-semibold opacity-90">üìÖ This Month Owed</p>
                    <div class="text-4xl opacity-30">üìÖ</div>
                </div>
                <p id="monthOwed" class="text-5xl font-black">$0</p>
                <p id="monthOwedJobs" class="text-sm opacity-75 mt-2">0 jobs</p>
            </div>

            <!-- Total Estimates -->
            <div class="stat-card bg-gradient-to-br from-blue-400 to-cyan-600 text-white p-6 rounded-2xl shadow-xl">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-sm font-semibold opacity-90">üìã Total Estimates</p>
                    <div class="text-4xl opacity-30">üìã</div>
                </div>
                <p id="totalEstimates" class="text-5xl font-black">$0</p>
                <p id="totalEstimatesCount" class="text-sm opacity-75 mt-2">0 estimates</p>
            </div>

            <!-- Month Estimates -->
            <div class="stat-card bg-gradient-to-br from-purple-400 to-indigo-600 text-white p-6 rounded-2xl shadow-xl">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-sm font-semibold opacity-90">üóìÔ∏è This Month Estimates</p>
                    <div class="text-4xl opacity-30">üóìÔ∏è</div>
                </div>
                <p id="monthEstimates" class="text-5xl font-black">$0</p>
                <p id="monthEstimatesCount" class="text-sm opacity-75 mt-2">0 estimates</p>
            </div>
        </div>

        <!-- Additional Stats Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="stat-card bg-gradient-to-br from-yellow-400 to-lime-600 text-white p-6 rounded-2xl shadow-xl">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-semibold opacity-90 mb-2">‚ö†Ô∏è Needs Follow-up</p>
                        <p id="needsFollowup" class="text-5xl font-black">0</p>
                        <p class="text-sm opacity-75 mt-2">Estimates with < 3 attempts</p>
                    </div>
                    <div class="text-6xl opacity-20">‚ö†Ô∏è</div>
                </div>
            </div>
            <div class="stat-card bg-gradient-to-br from-gray-400 to-slate-600 text-white p-6 rounded-2xl shadow-xl">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-semibold opacity-90 mb-2">‚è∞ Oldest Outstanding</p>
                        <p id="oldestDate" class="text-5xl font-black">-</p>
                        <p class="text-sm opacity-75 mt-2">days ago</p>
                    </div>
                    <div class="text-6xl opacity-20">‚è∞</div>
                </div>
            </div>
        </div>

        <!-- Estimates Section -->
        <div class="bg-white p-8 rounded-2xl shadow-xl mb-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-3xl font-black text-gray-800">üìã Active Estimates</h2>
                <div class="flex gap-3">
                    <button id="showAllEstimates" class="px-6 py-3 bg-gradient-to-r from-orange-500 to-red-600 text-white rounded-xl font-bold hover:from-orange-600 hover:to-red-700 shadow-lg transition-all">
                        All Time
                    </button>
                    <button id="showMonthEstimates" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-xl font-bold hover:bg-gray-400 shadow-lg transition-all">
                        This Month
                    </button>
                </div>
            </div>
            <div id="estimatesList" class="space-y-4"></div>
            <div id="estimatesEmptyMsg" style="display: none;" class="text-center py-16 bg-gradient-to-br from-gray-50 to-blue-50 rounded-xl">
                <p class="text-2xl text-gray-400 font-semibold">No active estimates! üéâ</p>
            </div>
        </div>

        <!-- Money Owed Section -->
        <div class="bg-white p-8 rounded-2xl shadow-xl">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-3xl font-black text-gray-800">üí∏ Outstanding Payments</h2>
                <div class="flex gap-3">
                    <button id="showAllOwed" class="px-6 py-3 bg-gradient-to-r from-red-500 to-pink-600 text-white rounded-xl font-bold hover:from-red-600 hover:to-pink-700 shadow-lg transition-all">
                        All Time
                    </button>
                    <button id="showMonthOwed" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-xl font-bold hover:bg-gray-400 shadow-lg transition-all">
                        This Month
                    </button>
                </div>
            </div>
            <div id="owedList" class="space-y-4"></div>
            <div id="owedEmptyMsg" style="display: none;" class="text-center py-16 bg-gradient-to-br from-gray-50 to-green-50 rounded-xl">
                <p class="text-2xl text-gray-400 font-semibold">No outstanding payments! üéâ</p>
            </div>
        </div>
    </div>

    <script>
       firebase.initializeApp({
    apiKey: "AIzaSyC8VwTY2i3kS41iy7FI_3ijCOFLV6LIwoA",
    authDomain: "action-az.firebaseapp.com",
    projectId: "action-az",
    storageBucket: "action-az.firebasestorage.app",
    messagingSenderId: "40939226263",
    appId: "1:40939226263:web:4cfc491a1e8008e86f55d2"
});
        });

        const db = firebase.database();
        const selected = localStorage.getItem('selectedPerson');
        let people = [];
        let logs = {};
        let showMonthOnlyOwed = false;
        let showMonthOnlyEstimates = false;

        if (!selected) {
            window.location.href = 'index.html';
        }

        db.ref('salespeople').once('value', snapshot => {
            const data = snapshot.val();
            people = data ? Object.keys(data).map(k => ({ id: k, name: data[k].name })) : [];
            const person = people.find(p => p.id === selected);
            if (person) {
                document.getElementById('personName').textContent = `Tracking for: ${person.name}`;
            }
        });

        db.ref('callLogs').on('value', snapshot => {
            logs = snapshot.val() || {};
            renderAll();
        });

        const dk = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;

        function getAllEstimates() {
            const allEstimates = [];
            Object.keys(logs).forEach(dateKey => {
                if (dateKey.startsWith(selected + '_')) {
                    const dateStr = dateKey.split('_')[1];
                    const callsObj = logs[dateKey];
                    Object.keys(callsObj).forEach(callId => {
                        const call = callsObj[callId];
                        if (call.leftEstimate && parseFloat(call.estimateAmount) > 0 && !call.jobSold && !call.estimateLost) {
                            allEstimates.push({
                                ...call,
                                date: dateStr,
                                dateKey: dateKey,
                                callId: callId,
                                followUpAttempts: call.followUpAttempts || 0,
                                followUpPlan: call.followUpPlan || ''
                            });
                        }
                    });
                }
            });
            return allEstimates.sort((a, b) => a.date.localeCompare(b.date));
        }

        function getAllOwed() {
            const allOwed = [];
            Object.keys(logs).forEach(dateKey => {
                if (dateKey.startsWith(selected + '_')) {
                    const dateStr = dateKey.split('_')[1];
                    const callsObj = logs[dateKey];
                    Object.keys(callsObj).forEach(callId => {
                        const call = callsObj[callId];
                        if (call.moneyOwed && parseFloat(call.moneyOwed) > 0) {
                            allOwed.push({
                                ...call,
                                date: dateStr,
                                dateKey: dateKey,
                                callId: callId
                            });
                        }
                    });
                }
            });
            return allOwed.sort((a, b) => a.date.localeCompare(b.date));
        }

        function renderAll() {
            const today = new Date();
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            const monthKey = dk(monthStart).substring(0, 7);

            const allEstimates = getAllEstimates();
            const allOwed = getAllOwed();

            const monthEstimates = allEstimates.filter(e => e.date.startsWith(monthKey));
            const monthOwed = allOwed.filter(e => e.date.startsWith(monthKey));

            const displayEstimates = showMonthOnlyEstimates ? monthEstimates : allEstimates;
            const displayOwed = showMonthOnlyOwed ? monthOwed : allOwed;

            // Summary Stats
            const totalOwedAmount = allOwed.reduce((sum, e) => sum + (parseFloat(e.moneyOwed) || 0), 0);
            const totalEstimatesAmount = allEstimates.reduce((sum, e) => sum + (parseFloat(e.estimateAmount) || 0), 0);
            const monthOwedAmount = monthOwed.reduce((sum, e) => sum + (parseFloat(e.moneyOwed) || 0), 0);
            const monthEstimatesAmount = monthEstimates.reduce((sum, e) => sum + (parseFloat(e.estimateAmount) || 0), 0);
            const needsFollowup = allEstimates.filter(e => (e.followUpAttempts || 0) < 3).length;

            document.getElementById('totalOwed').textContent = `$${totalOwedAmount.toLocaleString()}`;
            document.getElementById('totalOwedJobs').textContent = `${allOwed.length} jobs`;
            
            document.getElementById('monthOwed').textContent = `$${monthOwedAmount.toLocaleString()}`;
            document.getElementById('monthOwedJobs').textContent = `${monthOwed.length} jobs`;
            
            document.getElementById('totalEstimates').textContent = `$${totalEstimatesAmount.toLocaleString()}`;
            document.getElementById('totalEstimatesCount').textContent = `${allEstimates.length} estimates`;
            
            document.getElementById('monthEstimates').textContent = `$${monthEstimatesAmount.toLocaleString()}`;
            document.getElementById('monthEstimatesCount').textContent = `${monthEstimates.length} estimates`;
            
            document.getElementById('needsFollowup').textContent = needsFollowup;

            // Oldest Outstanding
            if (allOwed.length > 0 || allEstimates.length > 0) {
                const oldestOwed = allOwed.length > 0 ? new Date(allOwed[0].date) : null;
                const oldestEstimate = allEstimates.length > 0 ? new Date(allEstimates[0].date) : null;
                let oldestDate = oldestOwed;
                if (oldestEstimate && (!oldestOwed || oldestEstimate < oldestOwed)) {
                    oldestDate = oldestEstimate;
                }
                const daysDiff = Math.floor((today - oldestDate) / (1000 * 60 * 60 * 24));
                document.getElementById('oldestDate').textContent = `${daysDiff}`;
            } else {
                document.getElementById('oldestDate').textContent = '-';
            }

            // Render Estimates
            renderEstimates(displayEstimates);

            // Render Owed
            renderOwed(displayOwed);
        }

        function renderEstimates(estimates) {
            const container = document.getElementById('estimatesList');
            const emptyMsg = document.getElementById('estimatesEmptyMsg');

            if (estimates.length === 0) {
                container.style.display = 'none';
                emptyMsg.style.display = 'block';
            } else {
                container.style.display = 'block';
                emptyMsg.style.display = 'none';

                const today = new Date();
                container.innerHTML = estimates.map(est => {
                    const estDate = new Date(est.date);
                    const daysSince = Math.floor((today - estDate) / (1000 * 60 * 60 * 24));
                    const attempts = est.followUpAttempts || 0;
                    const urgency = daysSince > 14 ? 'red' : daysSince > 7 ? 'orange' : 'yellow';

                    return `
                        <div class="item-card p-6 bg-gradient-to-br from-${urgency}-50 to-${urgency}-100 rounded-2xl border-2 border-${urgency}-300 shadow-lg">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <p class="font-black text-2xl text-gray-800">${est.customerName || 'Unnamed Customer'}</p>
                                    <p class="text-sm font-semibold text-gray-600 mt-1">Job #${est.jobNumber || 'N/A'}</p>
                                    <p class="text-sm text-gray-600">${est.customerPhone || 'No phone'}</p>
                                    <p class="text-xs text-gray-500 mt-2 bg-white px-3 py-1 rounded-full inline-block">${daysSince} days ago ‚Ä¢ ${new Date(est.date).toLocaleDateString()}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-4xl font-black text-${urgency}-900">$${parseFloat(est.estimateAmount).toLocaleString()}</p>
                                    <p class="text-sm font-bold mt-2 ${attempts >= 3 ? 'text-red-600' : 'text-gray-700'} bg-white px-3 py-1 rounded-full">
                                        Follow-ups: ${attempts}/3
                                    </p>
                                </div>
                            </div>

                            <!-- Follow-up Plan -->
                            <div class="mb-4">
                                <label class="text-xs font-bold text-gray-700 block mb-2">üìù Follow-up Plan:</label>
                                <textarea 
                                    onchange="updateEstimate('${est.dateKey}', '${est.callId}', 'followUpPlan', this.value)" 
                                    class="w-full px-4 py-3 border-2 border-${urgency}-300 rounded-xl text-sm focus:outline-none focus:border-${urgency}-500" 
                                    rows="2" 
                                    placeholder="Add follow-up notes...">${est.followUpPlan || ''}</textarea>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex gap-3 flex-wrap">
                                ${attempts < 3 ? `
                                    <button onclick="incrementAttempt('${est.dateKey}', '${est.callId}', ${attempts})" 
                                        class="px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl font-bold hover:from-blue-600 hover:to-indigo-700 shadow-lg transition-all">
                                        üìû Mark Attempted (${attempts + 1}/3)
                                    </button>
                                ` : ''}
                                <button onclick="convertToSale('${est.dateKey}', '${est.callId}')" 
                                    class="px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl font-bold hover:from-green-600 hover:to-emerald-700 shadow-lg transition-all">
                                    ‚úì Converted to Sale
                                </button>
                                ${attempts >= 3 ? `
                                    <button onclick="markLost('${est.dateKey}', '${est.callId}')" 
                                        class="px-6 py-3 bg-gradient-to-r from-red-500 to-pink-600 text-white rounded-xl font-bold hover:from-red-600 hover:to-pink-700 shadow-lg transition-all">
                                        ‚úó Mark as Lost
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function renderOwed(owed) {
            const container = document.getElementById('owedList');
            const emptyMsg = document.getElementById('owedEmptyMsg');

            if (owed.length === 0) {
                container.style.display = 'none';
                emptyMsg.style.display = 'block';
            } else {
                container.style.display = 'block';
                emptyMsg.style.display = 'none';

                const today = new Date();
                container.innerHTML = owed.map(call => {
                    const callDate = new Date(call.date);
                    const daysSince = Math.floor((today - callDate) / (1000 * 60 * 60 * 24));
                    const urgency = daysSince > 30 ? 'red' : daysSince > 14 ? 'orange' : 'yellow';

                    return `
                        <div class="item-card p-6 bg-gradient-to-br from-${urgency}-50 to-${urgency}-100 rounded-2xl border-2 border-${urgency}-300 shadow-lg">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <p class="font-black text-2xl text-gray-800">${call.customerName || 'Unnamed Customer'}</p>
                                    <p class="text-sm font-semibold text-gray-600 mt-1">Job #${call.jobNumber || 'N/A'}</p>
                                    <p class="text-sm text-gray-600">${call.customerPhone || 'No phone'}</p>
                                    ${call.amountSold ? `
                                        <p class="text-sm text-gray-700 mt-2 bg-white px-3 py-1 rounded-full inline-block">Total Sale: $${parseFloat(call.amountSold).toLocaleString()}</p>
                                    ` : ''}
                                </div>
                                <div class="text-right">
                                    <p class="text-4xl font-black text-${urgency}-900">$${parseFloat(call.moneyOwed).toLocaleString()}</p>
                                    <p class="text-xs text-gray-600 mt-2 bg-white px-3 py-1 rounded-full">${daysSince} days ago</p>
                                    <p class="text-xs text-gray-500 mt-1">${new Date(call.date).toLocaleDateString()}</p>
                                </div>
                            </div>
                            <div class="flex gap-3 mt-4">
                                <button onclick="markPaid('${call.dateKey}', '${call.callId}')" 
                                    class="px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl font-bold hover:from-green-600 hover:to-emerald-700 shadow-lg transition-all">
                                    ‚úì Mark as Paid
                                </button>
                                <button onclick="updateOwedAmount('${call.dateKey}', '${call.callId}', ${call.moneyOwed})" 
                                    class="px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl font-bold hover:from-blue-600 hover:to-indigo-700 shadow-lg transition-all">
                                    Edit Amount
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function updateEstimate(dateKey, callId, field, value) {
            db.ref(`callLogs/${dateKey}/${callId}/${field}`).set(value);
        }

        function incrementAttempt(dateKey, callId, currentAttempts) {
            db.ref(`callLogs/${dateKey}/${callId}/followUpAttempts`).set(currentAttempts + 1);
        }

        function convertToSale(dateKey, callId) {
            if (confirm('Mark this estimate as converted to a sale?')) {
                db.ref(`callLogs/${dateKey}/${callId}`).update({
                    jobSold: true,
                    leftEstimate: false
                });
                alert('Estimate converted! Remember to enter the sale amount in the call log.');
            }
        }

        function markLost(dateKey, callId) {
            if (confirm('Mark this estimate as lost? It will be removed from the active list.')) {
                db.ref(`callLogs/${dateKey}/${callId}/estimateLost`).set(true);
            }
        }

        function markPaid(dateKey, callId) {
            if (confirm('Mark this payment as received?')) {
                db.ref(`callLogs/${dateKey}/${callId}/moneyOwed`).set(0);
            }
        }

        function updateOwedAmount(dateKey, callId, currentAmount) {
            const newAmount = prompt('Enter new amount owed:', currentAmount);
            if (newAmount !== null) {
                const amount = parseFloat(newAmount) || 0;
                db.ref(`callLogs/${dateKey}/${callId}/moneyOwed`).set(amount);
            }
        }

        // Filter buttons
        document.getElementById('showAllEstimates').onclick = () => {
            showMonthOnlyEstimates = false;
            document.getElementById('showAllEstimates').className = 'px-6 py-3 bg-gradient-to-r from-orange-500 to-red-600 text-white rounded-xl font-bold hover:from-orange-600 hover:to-red-700 shadow-lg transition-all';
            document.getElementById('showMonthEstimates').className = 'px-6 py-3 bg-gray-300 text-gray-700 rounded-xl font-bold hover:bg-gray-400 shadow-lg transition-all';
            renderAll();
        };

        document.getElementById('showMonthEstimates').onclick = () => {
            showMonthOnlyEstimates = true;
            document.getElementById('showMonthEstimates').className = 'px-6 py-3 bg-gradient-to-r from-orange-500 to-red-600 text-white rounded-xl font-bold hover:from-orange-600 hover:to-red-700 shadow-lg transition-all';
            document.getElementById('showAllEstimates').className = 'px-6 py-3 bg-gray-300 text-gray-700 rounded-xl font-bold hover:bg-gray-400 shadow-lg transition-all';
            renderAll();
        };

        document.getElementById('showAllOwed').onclick = () => {
            showMonthOnlyOwed = false;
            document.getElementById('showAllOwed').className = 'px-6 py-3 bg-gradient-to-r from-red-500 to-pink-600 text-white rounded-xl font-bold hover:from-red-600 hover:to-pink-700 shadow-lg transition-all';
            document.getElementById('showMonthOwed').className = 'px-6 py-3 bg-gray-300 text-gray-700 rounded-xl font-bold hover:bg-gray-400 shadow-lg transition-all';
            renderAll();
        };

        document.getElementById('showMonthOwed').onclick = () => {
            showMonthOnlyOwed = true;
            document.getElementById('showMonthOwed').className = 'px-6 py-3 bg-gradient-to-r from-red-500 to-pink-600 text-white rounded-xl font-bold hover:from-red-600 hover:to-pink-700 shadow-lg transition-all';
            document.getElementById('showAllOwed').className = 'px-6 py-3 bg-gray-300 text-gray-700 rounded-xl font-bold hover:bg-gray-400 shadow-lg transition-all';
            renderAll();
        };

        renderAll();
    </script>
</body>
</html>
