<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Individual Data - Action Plumbing</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="p-4" style="max-width: 1400px; margin: 0 auto;">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-3xl font-bold text-blue-900">üéØ Individual Performance</h1>
            <a href="index.html" class="px-4 py-2 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-700">‚Üê Back to Dashboard</a>
        </div>

        <div id="personName" class="text-xl font-bold text-gray-700 mb-4"></div>

        <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
            <div class="flex items-center justify-between mb-4">
                <button id="prevMonth" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">‚Üê Previous</button>
                <h2 id="monthYear" class="text-2xl font-bold text-blue-900"></h2>
                <button id="nextMonth" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">Next ‚Üí</button>
            </div>

            <!-- Goals Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Weekly Goals -->
                <div class="p-4 bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg border-2 border-green-300">
                    <h3 class="font-bold text-green-900 mb-3">üìÖ Weekly Goal</h3>
                    <input id="weeklyGoalInput" type="number" placeholder="Set weekly goal ($)" class="w-full px-3 py-2 border-2 border-green-300 rounded-lg mb-2 font-bold text-lg" />
                    <div id="weeklyProgress"></div>
                    <div class="mt-3 p-3 bg-white rounded border">
                        <p class="text-sm font-bold text-gray-700">Weekly Forecast</p>
                        <p id="weeklyForecast" class="text-2xl font-bold text-green-900">$0</p>
                        <p id="weeklyForecastNote" class="text-xs text-gray-600">Based on current pace</p>
                    </div>
                </div>

                <!-- Monthly Goals -->
                <div class="p-4 bg-gradient-to-br from-purple-50 to-indigo-50 rounded-lg border-2 border-purple-300">
                    <h3 class="font-bold text-purple-900 mb-3">üìä Monthly Goal</h3>
                    <input id="monthlyGoalInput" type="number" placeholder="Set monthly goal ($)" class="w-full px-3 py-2 border-2 border-purple-300 rounded-lg mb-2 font-bold text-lg" />
                    <div id="monthlyProgress"></div>
                    <div class="mt-3 p-3 bg-white rounded border">
                        <p class="text-sm font-bold text-gray-700">Monthly Forecast</p>
                        <p id="monthlyForecast" class="text-2xl font-bold text-purple-900">$0</p>
                        <p id="monthlyForecastNote" class="text-xs text-gray-600">Based on current pace</p>
                    </div>
                </div>
            </div>

            <!-- Yearly Goal -->
            <div class="p-4 bg-gradient-to-br from-blue-50 to-cyan-50 rounded-lg border-2 border-blue-300 mb-6">
                <h3 class="font-bold text-blue-900 mb-3">üèÜ Yearly Goal - <span id="yearDisplay"></span></h3>
                <input id="yearlyGoalInput" type="number" placeholder="Set yearly goal ($)" class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg mb-2 font-bold text-lg" />
                <div id="yearlyProgress"></div>
            </div>

            <!-- Performance Metrics Grid -->
            <h3 class="text-xl font-bold text-gray-800 mb-4">üìà Your Performance Metrics</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="p-4 bg-blue-50 rounded-lg border-2 border-blue-300">
                    <p class="text-sm font-bold text-blue-700">Close Percentage</p>
                    <p id="closeRate" class="text-3xl font-bold text-blue-900">0%</p>
                    <p id="closeDetails" class="text-xs text-gray-600">0 / 0</p>
                </div>
                <div class="p-4 bg-green-50 rounded-lg border-2 border-green-300">
                    <p class="text-sm font-bold text-green-700">Calls Taken</p>
                    <p id="callsTaken" class="text-3xl font-bold text-green-900">0</p>
                    <p class="text-xs text-gray-600">this month</p>
                </div>
                <div class="p-4 bg-purple-50 rounded-lg border-2 border-purple-300">
                    <p class="text-sm font-bold text-purple-700">Calls Sold</p>
                    <p id="callsSold" class="text-3xl font-bold text-purple-900">0</p>
                    <p class="text-xs text-gray-600">this month</p>
                </div>
                <div class="p-4 bg-orange-50 rounded-lg border-2 border-orange-300">
                    <p class="text-sm font-bold text-orange-700">Estimates Left</p>
                    <p id="estimatesLeft" class="text-3xl font-bold text-orange-900">0</p>
                    <p id="estimateValue" class="text-xs text-gray-600">$0 potential</p>
                </div>
                <div class="p-4 bg-teal-50 rounded-lg border-2 border-teal-300">
                    <p class="text-sm font-bold text-teal-700">Avg Sale Amount</p>
                    <p id="avgSale" class="text-3xl font-bold text-teal-900">$0</p>
                    <p class="text-xs text-gray-600">per sale</p>
                </div>
                <div class="p-4 bg-indigo-50 rounded-lg border-2 border-indigo-300">
                    <p class="text-sm font-bold text-indigo-700">Week Revenue</p>
                    <p id="weekRevenue" class="text-3xl font-bold text-indigo-900">$0</p>
                    <p class="text-xs text-gray-600">last 7 days</p>
                </div>
                <div class="p-4 bg-pink-50 rounded-lg border-2 border-pink-300">
                    <p class="text-sm font-bold text-pink-700">Month Revenue</p>
                    <p id="monthRevenue" class="text-3xl font-bold text-pink-900">$0</p>
                    <p class="text-xs text-gray-600">this month</p>
                </div>
                <div class="p-4 bg-cyan-50 rounded-lg border-2 border-cyan-300">
                    <p class="text-sm font-bold text-cyan-700">Year Revenue</p>
                    <p id="yearRevenue" class="text-3xl font-bold text-cyan-900">$0</p>
                    <p class="text-xs text-gray-600">YTD total</p>
                </div>
                <div class="p-4 bg-lime-50 rounded-lg border-2 border-lime-300">
                    <p class="text-sm font-bold text-lime-700">üö™ 3 Door Knocks</p>
                    <p id="doorKnocks" class="text-3xl font-bold text-lime-900">0</p>
                    <p id="doorKnocksRate" class="text-xs text-gray-600">0% conversion</p>
                </div>
                <div class="p-4 bg-yellow-50 rounded-lg border-2 border-yellow-300">
                    <p class="text-sm font-bold text-yellow-700">Review Rate</p>
                    <p id="reviewRate" class="text-3xl font-bold text-yellow-900">0%</p>
                    <p id="reviewCount" class="text-xs text-gray-600">0 reviews</p>
                </div>
                <div class="p-4 bg-red-50 rounded-lg border-2 border-red-300">
                    <p class="text-sm font-bold text-red-700">Membership Rate</p>
                    <p id="membershipRate" class="text-3xl font-bold text-red-900">0%</p>
                    <p id="membershipCount" class="text-xs text-gray-600">0 plans</p>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg border-2 border-gray-300">
                    <p class="text-sm font-bold text-gray-700">Days Since Sale</p>
                    <p id="daysSinceSale" class="text-3xl font-bold text-gray-900">0</p>
                    <p class="text-xs text-gray-600">keep it low!</p>
                </div>
            </div>

            <!-- Turnover Stats Section -->
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-lg border-2 border-purple-300 mb-6">
                <h3 class="text-xl font-bold text-purple-900 mb-4">üîÑ Your Turnover Performance</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-white p-4 rounded-lg border-2 border-purple-300">
                        <p class="text-sm font-bold text-purple-700">Turnovers Received</p>
                        <p id="turnoversReceived" class="text-4xl font-bold text-purple-900">0</p>
                        <p id="turnoversReceivedRevenue" class="text-xs text-gray-600">$0 closed</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg border-2 border-pink-300">
                        <p class="text-sm font-bold text-pink-700">Turnovers Given</p>
                        <p id="turnoversGiven" class="text-4xl font-bold text-pink-900">0</p>
                        <p id="turnoversGivenRevenue" class="text-xs text-gray-600">$0 closed by others</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg border-2 border-indigo-300">
                        <p class="text-sm font-bold text-indigo-700">Turnover Close Rate</p>
                        <p id="turnoverCloseRate" class="text-4xl font-bold text-indigo-900">0%</p>
                        <p class="text-xs text-gray-600">of turnovers received</p>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg border-2 border-purple-300">
                    <h4 class="text-sm font-bold text-purple-700 mb-2">Who Gave You Turnovers This Month</h4>
                    <div id="turnoverSources" class="space-y-2"></div>
                </div>
            </div>

            <!-- Trade Analysis Section -->
            <div class="bg-gradient-to-r from-blue-50 to-cyan-50 p-6 rounded-lg border-2 border-blue-300 mb-6">
                <h3 class="text-xl font-bold text-blue-900 mb-4">üîß Your Trade Analysis</h3>
                
                <!-- Jobs Sold by Trade -->
                <div class="mb-6">
                    <h4 class="text-lg font-bold text-gray-800 mb-3">Jobs Sold by Trade</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Plumbing -->
                        <div class="bg-white p-4 rounded-lg border-2 border-blue-300">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-blue-700">üîß Plumbing</span>
                                <span class="text-2xl font-bold text-blue-900" id="plumbingJobs">0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
                                <div id="plumbingBar" class="bg-blue-500 h-full rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-600">
                                <span id="plumbingPercent">0%</span>
                                <span id="plumbingRevenue">$0</span>
                            </div>
                        </div>

                        <!-- HVAC -->
                        <div class="bg-white p-4 rounded-lg border-2 border-red-300">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-red-700">üå°Ô∏è HVAC</span>
                                <span class="text-2xl font-bold text-red-900" id="hvacJobs">0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
                                <div id="hvacBar" class="bg-red-500 h-full rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-600">
                                <span id="hvacPercent">0%</span>
                                <span id="hvacRevenue">$0</span>
                            </div>
                        </div>

                        <!-- Electrical -->
                        <div class="bg-white p-4 rounded-lg border-2 border-yellow-300">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-yellow-700">‚ö° Electrical</span>
                                <span class="text-2xl font-bold text-yellow-900" id="electricalJobs">0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
                                <div id="electricalBar" class="bg-yellow-500 h-full rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-600">
                                <span id="electricalPercent">0%</span>
                                <span id="electricalRevenue">$0</span>
                            </div>
                        </div>

                        <!-- Cameras -->
                        <div class="bg-white p-4 rounded-lg border-2 border-purple-300">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-purple-700">üìπ Cameras</span>
                                <span class="text-2xl font-bold text-purple-900" id="camerasJobs">0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
                                <div id="camerasBar" class="bg-purple-500 h-full rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-600">
                                <span id="camerasPercent">0%</span>
                                <span id="camerasRevenue">$0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Money Owed by Trade -->
                <div>
                    <h4 class="text-lg font-bold text-gray-800 mb-3">üí∞ Money Owed by Trade</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Plumbing Owed -->
                        <div class="bg-white p-4 rounded-lg border-2 border-blue-300">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-blue-700">üîß Plumbing</span>
                                <span class="text-2xl font-bold text-blue-900" id="plumbingOwed">$0</span>
                            </div>
                            <p class="text-xs text-gray-600 mt-1" id="plumbingOwedJobs">0 jobs outstanding</p>
                        </div>

                        <!-- HVAC Owed -->
                        <div class="bg-white p-4 rounded-lg border-2 border-red-300">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-red-700">üå°Ô∏è HVAC</span>
                                <span class="text-2xl font-bold text-red-900" id="hvacOwed">$0</span>
                            </div>
                            <p class="text-xs text-gray-600 mt-1" id="hvacOwedJobs">0 jobs outstanding</p>
                        </div>

                        <!-- Electrical Owed -->
                        <div class="bg-white p-4 rounded-lg border-2 border-yellow-300">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-yellow-700">‚ö° Electrical</span>
                                <span class="text-2xl font-bold text-yellow-900" id="electricalOwed">$0</span>
                            </div>
                            <p class="text-xs text-gray-600 mt-1" id="electricalOwedJobs">0 jobs outstanding</p>
                        </div>

                        <!-- Cameras Owed -->
                        <div class="bg-white p-4 rounded-lg border-2 border-purple-300">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-purple-700">üìπ Cameras</span>
                                <span class="text-2xl font-bold text-purple-900" id="camerasOwed">$0</span>
                            </div>
                            <p class="text-xs text-gray-600 mt-1" id="camerasOwedJobs">0 jobs outstanding</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Yearly Contribution Section -->
            <div class="bg-gradient-to-r from-indigo-50 to-blue-50 p-6 rounded-lg border-2 border-indigo-300 mb-6">
                <h3 class="text-xl font-bold text-indigo-900 mb-4">üèÜ Your Yearly Contribution - <span id="yearContributionDisplay"></span></h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="bg-white p-4 rounded-lg border-2 border-indigo-300">
                        <p class="text-sm font-bold text-indigo-700">Your Year Total</p>
                        <p id="yourYearTotal" class="text-4xl font-bold text-indigo-900">$0</p>
                        <p id="yourYearJobs" class="text-xs text-gray-600">0 jobs closed</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg border-2 border-blue-300">
                        <p class="text-sm font-bold text-blue-700">Team Year Total</p>
                        <p id="teamYearTotal" class="text-4xl font-bold text-blue-900">$0</p>
                        <p id="teamYearJobs" class="text-xs text-gray-600">0 jobs closed</p>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg border-2 border-indigo-300 mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-sm font-bold text-indigo-700">Your % of Team Total</p>
                        <p id="yourTeamPercent" class="text-3xl font-bold text-indigo-900">0%</p>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div id="yourTeamPercentBar" class="bg-indigo-500 h-full rounded-full" style="width: 0%"></div>
                    </div>
                </div>

                <div id="teamGoalSection" class="bg-white p-4 rounded-lg border-2 border-blue-300" style="display: none;">
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-sm font-bold text-blue-700">Your Contribution to Team Goal</p>
                        <p id="yourGoalPercent" class="text-3xl font-bold text-blue-900">0%</p>
                    </div>
                    <p id="teamGoalAmount" class="text-xs text-gray-600 mb-2">Team Goal: $0</p>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div id="yourGoalPercentBar" class="bg-blue-500 h-full rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Streak Badge -->
            <div id="streakBadge" class="p-4 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg border-2 border-yellow-400 text-center">
                <p class="text-sm font-bold text-orange-700">üî• CURRENT STREAK</p>
                <p id="streakDays" class="text-5xl font-bold text-orange-900">0</p>
                <p class="text-xs text-gray-600">consecutive days with sales</p>
            </div>
        </div>
    </div>

    <script>
       firebase.initializeApp({
    apiKey: "AIzaSyC8VwTY2i3kS41iy7FI_3ijCOFLV6LIwoA",
    authDomain: "action-az.firebaseapp.com",
    projectId: "action-az",
    storageBucket: "action-az.firebasestorage.app",
    messagingSenderId: "40939226263",
    appId: "1:40939226263:web:4cfc491a1e8008e86f55d2"
});

        const db = firebase.database();
        const selected = localStorage.getItem('selectedPerson');
        let currentDate = new Date();
        let people = [];
        let logs = {};
        let weeklyGoals = {};
        let monthlyGoals = {};
        let yearlyGoals = {};
        let tyGoal = 0;
        let currentWeekKey = '';
        let currentMonthKey = '';
        let currentYearKey = '';

        if (!selected) {
            window.location.href = 'index.html';
        }

        let dataReady = { people: false, logs: false, weekly: false, monthly: false, yearly: false };

function tryRender() {
    if (Object.values(dataReady).every(Boolean)) {
        loadGoals();
    }
}

db.ref('salespeople').on('value', snapshot => {
    const data = snapshot.val();
    people = data ? Object.keys(data).map(k => ({ id: k, name: data[k].name })) : [];
    const person = people.find(p => p.id === selected);
    if (person) {
        document.getElementById('personName').textContent = `Performance for: ${person.name}`;
    }
    dataReady.people = true;
    tryRender();
});

db.ref('callLogs').on('value', snapshot => {
    logs = snapshot.val() || {};
    dataReady.logs = true;
    tryRender();
});

db.ref('weeklyGoals').on('value', snapshot => {
    weeklyGoals = snapshot.val() || {};
    dataReady.weekly = true;
    tryRender();
});

db.ref('monthlyGoals').on('value', snapshot => {
    monthlyGoals = snapshot.val() || {};
    dataReady.monthly = true;
    tryRender();
});

db.ref('yearlyGoals').on('value', snapshot => {
    yearlyGoals = snapshot.val() || {};
    dataReady.yearly = true;
    tryRender();
});

        const dk = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        const wk = d => {
            const week = getWeek(d);
            return `${dk(week[0])}_${dk(week[6])}`;
        };
        const mk = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        const yk = d => `${d.getFullYear()}`;

        function getWeek(date) {
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(date);
            monday.setDate(diff);
            const week = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(monday);
                d.setDate(monday.getDate() + i);
                week.push(d);
            }
            return week;
        }

        function getMDates(date) {
            const y = date.getFullYear();
            const m = date.getMonth();
            const arr = [];
            const last = new Date(y, m+1, 0).getDate();
            for (let day = 1; day <= last; day++) arr.push(new Date(y, m, day));
            return arr;
        }

        function getYDates(year) {
            const arr = [];
            for (let m = 0; m < 12; m++) {
                arr.push(...getMDates(new Date(year, m, 1)));
            }
            return arr;
        }

        function getCalls(pid, d) {
            const key = `${pid}_${dk(d)}`;
            const l = logs[key];
            if (!l) return [];
            return Object.values(l);
        }

        function calc(pid, dates) {
            const t = {
                totalCalls: 0, callsSold: 0, amountSold: 0,
                estimatesLeft: 0, estimateValue: 0,
                doorKnocks: 0, doorKnocksSold: 0,
                reviewsCompleted: 0, membershipPlansSold: 0,
                turnoversReceived: 0, turnoversReceivedRevenue: 0,
                turnoversGiven: 0,
                turnoverSources: {},
                trades: {
                    plumbing: { jobs: 0, revenue: 0, owed: 0, owedJobs: 0 },
                    hvac: { jobs: 0, revenue: 0, owed: 0, owedJobs: 0 },
                    electrical: { jobs: 0, revenue: 0, owed: 0, owedJobs: 0 },
                    cameras: { jobs: 0, revenue: 0, owed: 0, owedJobs: 0 }
                }
            };
            dates.forEach(d => {
                const calls = getCalls(pid, d);
                calls.forEach(c => {
                    t.totalCalls++;
                    if (c.jobSold) {
                        t.callsSold++;
                        t.amountSold += parseFloat(c.amountSold) || 0;
                        if (c.threeDoorKnocks) t.doorKnocksSold++;
                        
                        // Track turnovers received
                        if (c.soldFromTurnover && c.turnoverFrom) {
                            t.turnoversReceived++;
                            t.turnoversReceivedRevenue += parseFloat(c.amountSold) || 0;
                            if (!t.turnoverSources[c.turnoverFrom]) {
                                t.turnoverSources[c.turnoverFrom] = { count: 0, revenue: 0 };
                            }
                            t.turnoverSources[c.turnoverFrom].count++;
                            t.turnoverSources[c.turnoverFrom].revenue += parseFloat(c.amountSold) || 0;
                        }
                        
                        // Track by trade
                        const revenue = parseFloat(c.amountSold) || 0;
                        if (c.tradePlumbing) {
                            t.trades.plumbing.jobs++;
                            t.trades.plumbing.revenue += revenue;
                        }
                        if (c.tradeHVAC) {
                            t.trades.hvac.jobs++;
                            t.trades.hvac.revenue += revenue;
                        }
                        if (c.tradeElectrical) {
                            t.trades.electrical.jobs++;
                            t.trades.electrical.revenue += revenue;
                        }
                        if (c.tradeCameras) {
                            t.trades.cameras.jobs++;
                            t.trades.cameras.revenue += revenue;
                        }
                    }
                    
                    // Track money owed by trade
                    const owed = parseFloat(c.moneyOwed) || 0;
                    if (owed > 0) {
                        if (c.tradePlumbing) {
                            t.trades.plumbing.owed += owed;
                            t.trades.plumbing.owedJobs++;
                        }
                        if (c.tradeHVAC) {
                            t.trades.hvac.owed += owed;
                            t.trades.hvac.owedJobs++;
                        }
                        if (c.tradeElectrical) {
                            t.trades.electrical.owed += owed;
                            t.trades.electrical.owedJobs++;
                        }
                        if (c.tradeCameras) {
                            t.trades.cameras.owed += owed;
                            t.trades.cameras.owedJobs++;
                        }
                    }
                    
                    if (c.leftEstimate) {
                        t.estimatesLeft++;
                        t.estimateValue += parseFloat(c.estimateAmount) || 0;
                    }
                    if (c.threeDoorKnocks) t.doorKnocks++;
                    if (c.reviewCompleted) t.reviewsCompleted++;
                    if (c.membershipPlanSold) t.membershipPlansSold++;
                });

                // Count turnovers given (all other people's calls where turnoverFrom = selected)
                people.forEach(p => {
                    if (p.id !== pid) {
                        const otherCalls = getCalls(p.id, d);
                        otherCalls.forEach(c => {
                            if (c.soldFromTurnover && c.turnoverFrom === pid && c.jobSold) {
                                t.turnoversGiven++;
                            }
                        });
                    }
                });
            });
            return t;
        }

        function calcTeamTotal(dates) {
            let total = 0;
            let jobs = 0;
            people.forEach(p => {
                dates.forEach(d => {
                    const calls = getCalls(p.id, d);
                    calls.forEach(c => {
                        if (c.jobSold) {
                            total += parseFloat(c.amountSold) || 0;
                            jobs++;
                        }
                    });
                });
            });
            return { total, jobs };
        }

        function getStreak() {
            let streak = 0;
            const today = new Date();
            for (let i = 0; i < 365; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                const calls = getCalls(selected, d);
                const hasSale = calls.some(c => c.jobSold);
                if (hasSale) streak++;
                else if (i > 0) break;
            }
            return streak;
        }

        function getDaysSinceSale() {
            const today = new Date();
            for (let i = 0; i < 365; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                const calls = getCalls(selected, d);
                if (calls.some(c => c.jobSold)) return i;
            }
            return 365;
        }

        function loadGoals() {
            currentWeekKey = wk(currentDate);
            currentMonthKey = mk(currentDate);
            currentYearKey = yk(currentDate);

            const weekGoal = weeklyGoals[`${selected}_${currentWeekKey}`] || 0;
            document.getElementById('weeklyGoalInput').value = weekGoal || '';

            const monthGoal = monthlyGoals[`${selected}_${currentMonthKey}`] || 0;
            document.getElementById('monthlyGoalInput').value = monthGoal || '';

            const yearGoal = yearlyGoals[`${selected}_${currentYearKey}`] || 0;
            document.getElementById('yearlyGoalInput').value = yearGoal || '';

            // Load team yearly goal
            db.ref(`teamYearlyGoals/${currentYearKey}`).once('value', snapshot => {
                tyGoal = snapshot.val() || 0;
                renderAll();
            });

            renderAll();
        }

        document.getElementById('weeklyGoalInput').onchange = (e) => {
            const val = parseFloat(e.target.value) || 0;
            db.ref(`weeklyGoals/${selected}_${currentWeekKey}`).set(val);
            renderAll();
        };

        document.getElementById('monthlyGoalInput').onchange = (e) => {
            const val = parseFloat(e.target.value) || 0;
            db.ref(`monthlyGoals/${selected}_${currentMonthKey}`).set(val);
            renderAll();
        };

        document.getElementById('yearlyGoalInput').onchange = (e) => {
            const val = parseFloat(e.target.value) || 0;
            db.ref(`yearlyGoals/${selected}_${currentYearKey}`).set(val);
            renderAll();
        };

        function renderAll() {
            const week = getWeek(currentDate);
            const month = getMDates(currentDate);
            const year = getYDates(currentDate.getFullYear());

            const weekStats = calc(selected, week);
            const monthStats = calc(selected, month);
            const yearStats = calc(selected, year);
            const teamYearStats = calcTeamTotal(year);

            document.getElementById('monthYear').textContent = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            document.getElementById('yearDisplay').textContent = currentDate.getFullYear();
            document.getElementById('yearContributionDisplay').textContent = currentDate.getFullYear();

            // Weekly Goal
            const weekGoal = weeklyGoals[`${selected}_${currentWeekKey}`] || 0;
            if (weekGoal > 0) {
                const progress = (weekStats.amountSold / weekGoal) * 100;
                document.getElementById('weeklyProgress').innerHTML = `
                    <div class="mb-2">
                        <div class="flex justify-between text-sm mb-1">
                            <span>Progress:</span>
                            <span class="font-bold">${progress.toFixed(1)}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-6">
                            <div class="${progress >= 100 ? 'bg-green-600' : progress >= 50 ? 'bg-yellow-500' : 'bg-red-500'} h-full rounded-full flex items-center justify-center text-white text-xs font-bold" style="width: ${Math.min(progress, 100)}%">
                                ${progress.toFixed(0)}%
                            </div>
                        </div>
                        <div class="flex justify-between text-xs mt-1">
                            <span>$${weekStats.amountSold.toLocaleString()}</span>
                            <span>Goal: $${weekGoal.toLocaleString()}</span>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('weeklyProgress').innerHTML = '<p class="text-sm text-gray-500">Set a weekly goal to track progress</p>';
            }

            // Weekly Forecast
            const today = new Date();
            const daysInWeek = 7;
            const daysPassed = week.filter(d => d <= today).length;
            const weekDailyAvg = daysPassed > 0 ? weekStats.amountSold / daysPassed : 0;
            const weekForecast = weekDailyAvg * daysInWeek;
            document.getElementById('weeklyForecast').textContent = `$${Math.round(weekForecast).toLocaleString()}`;
            document.getElementById('weeklyForecastNote').textContent = `Based on $${Math.round(weekDailyAvg).toLocaleString()}/day`;

            // Monthly Goal
            const monthGoal = monthlyGoals[`${selected}_${currentMonthKey}`] || 0;
            if (monthGoal > 0) {
                const progress = (monthStats.amountSold / monthGoal) * 100;
                document.getElementById('monthlyProgress').innerHTML = `
                    <div class="mb-2">
                        <div class="flex justify-between text-sm mb-1">
                            <span>Progress:</span>
                            <span class="font-bold">${progress.toFixed(1)}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-6">
                            <div class="${progress >= 100 ? 'bg-green-600' : progress >= 50 ? 'bg-yellow-500' : 'bg-red-500'} h-full rounded-full flex items-center justify-center text-white text-xs font-bold" style="width: ${Math.min(progress, 100)}%">
                                ${progress.toFixed(0)}%
                            </div>
                        </div>
                        <div class="flex justify-between text-xs mt-1">
                            <span>$${monthStats.amountSold.toLocaleString()}</span>
                            <span>Goal: $${monthGoal.toLocaleString()}</span>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('monthlyProgress').innerHTML = '<p class="text-sm text-gray-500">Set a monthly goal to track progress</p>';
            }

            // Monthly Forecast
            const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            const monthDaysPassed = currentDate.getMonth() === today.getMonth() && currentDate.getFullYear() === today.getFullYear() ? today.getDate() : daysInMonth;
            const monthDailyAvg = monthDaysPassed > 0 ? monthStats.amountSold / monthDaysPassed : 0;
            const monthForecast = monthDailyAvg * daysInMonth;
            document.getElementById('monthlyForecast').textContent = `$${Math.round(monthForecast).toLocaleString()}`;
            document.getElementById('monthlyForecastNote').textContent = `Based on $${Math.round(monthDailyAvg).toLocaleString()}/day`;

            // Yearly Goal
            const yearGoal = yearlyGoals[`${selected}_${currentYearKey}`] || 0;
            if (yearGoal > 0) {
                const progress = (yearStats.amountSold / yearGoal) * 100;
                document.getElementById('yearlyProgress').innerHTML = `
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span>Progress:</span>
                            <span class="font-bold">${progress.toFixed(1)}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-6">
                            <div class="${progress >= 100 ? 'bg-green-600' : progress >= 50 ? 'bg-yellow-500' : 'bg-red-500'} h-full rounded-full flex items-center justify-center text-white text-xs font-bold" style="width: ${Math.min(progress, 100)}%">
                                ${progress.toFixed(0)}%
                            </div>
                        </div>
                        <div class="flex justify-between text-xs mt-1">
                            <span>$${yearStats.amountSold.toLocaleString()}</span>
                            <span>Goal: $${yearGoal.toLocaleString()}</span>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('yearlyProgress').innerHTML = '<p class="text-sm text-gray-500">Set a yearly goal to track progress</p>';
            }

            // Performance Metrics
            const closeRate = monthStats.totalCalls > 0 ? ((monthStats.callsSold / monthStats.totalCalls) * 100).toFixed(1) : 0;
            document.getElementById('closeRate').textContent = `${closeRate}%`;
            document.getElementById('closeDetails').textContent = `${monthStats.callsSold} / ${monthStats.totalCalls}`;

            document.getElementById('callsTaken').textContent = monthStats.totalCalls;
            document.getElementById('callsSold').textContent = monthStats.callsSold;

            document.getElementById('estimatesLeft').textContent = monthStats.estimatesLeft;
            document.getElementById('estimateValue').textContent = `$${monthStats.estimateValue.toLocaleString()} potential`;

            const avgSale = monthStats.callsSold > 0 ? (monthStats.amountSold / monthStats.callsSold).toFixed(0) : 0;
            document.getElementById('avgSale').textContent = `$${avgSale}`;

            document.getElementById('weekRevenue').textContent = `$${weekStats.amountSold.toLocaleString()}`;
            document.getElementById('monthRevenue').textContent = `$${monthStats.amountSold.toLocaleString()}`;
            document.getElementById('yearRevenue').textContent = `$${yearStats.amountSold.toLocaleString()}`;

            document.getElementById('doorKnocks').textContent = monthStats.doorKnocks;
            const doorRate = monthStats.doorKnocks > 0 ? ((monthStats.doorKnocksSold / monthStats.doorKnocks) * 100).toFixed(1) : 0;
            document.getElementById('doorKnocksRate').textContent = `${doorRate}% conversion`;

            const reviewRate = monthStats.totalCalls > 0 ? ((monthStats.reviewsCompleted / monthStats.totalCalls) * 100).toFixed(1) : 0;
            document.getElementById('reviewRate').textContent = `${reviewRate}%`;
            document.getElementById('reviewCount').textContent = `${monthStats.reviewsCompleted} reviews`;

            const membershipRate = monthStats.callsSold > 0 ? ((monthStats.membershipPlansSold / monthStats.callsSold) * 100).toFixed(1) : 0;
            document.getElementById('membershipRate').textContent = `${membershipRate}%`;
            document.getElementById('membershipCount').textContent = `${monthStats.membershipPlansSold} plans`;

            const daysSince = getDaysSinceSale();
            document.getElementById('daysSinceSale').textContent = daysSince;

            const streak = getStreak();
            document.getElementById('streakDays').textContent = streak;

            // Turnover Stats
            document.getElementById('turnoversReceived').textContent = monthStats.turnoversReceived;
            document.getElementById('turnoversReceivedRevenue').textContent = `$${monthStats.turnoversReceivedRevenue.toLocaleString()} closed`;

            document.getElementById('turnoversGiven').textContent = monthStats.turnoversGiven;
            
            // Calculate revenue from turnovers given
            let turnoversGivenRevenue = 0;
            people.forEach(p => {
                if (p.id !== selected) {
                    month.forEach(d => {
                        const calls = getCalls(p.id, d);
                        calls.forEach(c => {
                            if (c.soldFromTurnover && c.turnoverFrom === selected && c.jobSold) {
                                turnoversGivenRevenue += parseFloat(c.amountSold) || 0;
                            }
                        });
                    });
                }
            });
            document.getElementById('turnoversGivenRevenue').textContent = `$${turnoversGivenRevenue.toLocaleString()} closed by others`;

            const turnoverCloseRate = monthStats.turnoversReceived > 0 ? ((monthStats.turnoversReceived / monthStats.turnoversReceived) * 100).toFixed(1) : 0;
            document.getElementById('turnoverCloseRate').textContent = `${turnoverCloseRate}%`;

            // Turnover Sources
            const sourceArray = Object.entries(monthStats.turnoverSources).map(([id, data]) => {
                const person = people.find(p => p.id === id);
                return { id, name: person ? person.name : 'Unknown', ...data };
            }).sort((a, b) => b.count - a.count);

            document.getElementById('turnoverSources').innerHTML = sourceArray.length > 0 ? sourceArray.map(source => `
                <div class="flex justify-between items-center p-2 bg-purple-50 rounded">
                    <span class="font-semibold">${source.name}</span>
                    <span class="text-sm text-gray-600">${source.count} leads ‚Ä¢ $${source.revenue.toLocaleString()}</span>
                </div>
            `).join('') : '<p class="text-center text-gray-500 text-sm">No turnovers received this month</p>';

            // Trade Analysis
            const totalTradeJobs = monthStats.trades.plumbing.jobs + monthStats.trades.hvac.jobs + 
                                   monthStats.trades.electrical.jobs + monthStats.trades.cameras.jobs;
            
            // Plumbing
            const plumbingPercent = totalTradeJobs > 0 ? (monthStats.trades.plumbing.jobs / totalTradeJobs * 100).toFixed(1) : 0;
            document.getElementById('plumbingJobs').textContent = monthStats.trades.plumbing.jobs;
            document.getElementById('plumbingBar').style.width = `${plumbingPercent}%`;
            document.getElementById('plumbingPercent').textContent = `${plumbingPercent}%`;
            document.getElementById('plumbingRevenue').textContent = `$${monthStats.trades.plumbing.revenue.toLocaleString()}`;
            document.getElementById('plumbingOwed').textContent = `$${monthStats.trades.plumbing.owed.toLocaleString()}`;
            document.getElementById('plumbingOwedJobs').textContent = `${monthStats.trades.plumbing.owedJobs} jobs outstanding`;

            // HVAC
            const hvacPercent = totalTradeJobs > 0 ? (monthStats.trades.hvac.jobs / totalTradeJobs * 100).toFixed(1) : 0;
            document.getElementById('hvacJobs').textContent = monthStats.trades.hvac.jobs;
            document.getElementById('hvacBar').style.width = `${hvacPercent}%`;
            document.getElementById('hvacPercent').textContent = `${hvacPercent}%`;
            document.getElementById('hvacRevenue').textContent = `$${monthStats.trades.hvac.revenue.toLocaleString()}`;
            document.getElementById('hvacOwed').textContent = `$${monthStats.trades.hvac.owed.toLocaleString()}`;
            document.getElementById('hvacOwedJobs').textContent = `${monthStats.trades.hvac.owedJobs} jobs outstanding`;

            // Electrical
            const electricalPercent = totalTradeJobs > 0 ? (monthStats.trades.electrical.jobs / totalTradeJobs * 100).toFixed(1) : 0;
            document.getElementById('electricalJobs').textContent = monthStats.trades.electrical.jobs;
            document.getElementById('electricalBar').style.width = `${electricalPercent}%`;
            document.getElementById('electricalPercent').textContent = `${electricalPercent}%`;
            document.getElementById('electricalRevenue').textContent = `$${monthStats.trades.electrical.revenue.toLocaleString()}`;
            document.getElementById('electricalOwed').textContent = `$${monthStats.trades.electrical.owed.toLocaleString()}`;
            document.getElementById('electricalOwedJobs').textContent = `${monthStats.trades.electrical.owedJobs} jobs outstanding`;

            // Cameras
            const camerasPercent = totalTradeJobs > 0 ? (monthStats.trades.cameras.jobs / totalTradeJobs * 100).toFixed(1) : 0;
            document.getElementById('camerasJobs').textContent = monthStats.trades.cameras.jobs;
            document.getElementById('camerasBar').style.width = `${camerasPercent}%`;
            document.getElementById('camerasPercent').textContent = `${camerasPercent}%`;
            document.getElementById('camerasRevenue').textContent = `$${monthStats.trades.cameras.revenue.toLocaleString()}`;
            document.getElementById('camerasOwed').textContent = `$${monthStats.trades.cameras.owed.toLocaleString()}`;
            document.getElementById('camerasOwedJobs').textContent = `${monthStats.trades.cameras.owedJobs} jobs outstanding`;

            // Yearly Contribution
            document.getElementById('yourYearTotal').textContent = `$${yearStats.amountSold.toLocaleString()}`;
            document.getElementById('yourYearJobs').textContent = `${yearStats.callsSold} jobs closed`;
            document.getElementById('teamYearTotal').textContent = `$${teamYearStats.total.toLocaleString()}`;
            document.getElementById('teamYearJobs').textContent = `${teamYearStats.jobs} jobs closed`;

            const yourPercent = teamYearStats.total > 0 ? (yearStats.amountSold / teamYearStats.total * 100).toFixed(1) : 0;
            document.getElementById('yourTeamPercent').textContent = `${yourPercent}%`;
            document.getElementById('yourTeamPercentBar').style.width = `${Math.min(yourPercent, 100)}%`;

            if (tyGoal > 0) {
                document.getElementById('teamGoalSection').style.display = 'block';
                const goalContribution = (yearStats.amountSold / tyGoal * 100).toFixed(1);
                document.getElementById('yourGoalPercent').textContent = `${goalContribution}%`;
                document.getElementById('teamGoalAmount').textContent = `Team Goal: $${tyGoal.toLocaleString()}`;
                document.getElementById('yourGoalPercentBar').style.width = `${Math.min(goalContribution, 100)}%`;
            } else {
                document.getElementById('teamGoalSection').style.display = 'none';
            }
        }

        document.getElementById('prevMonth').onclick = () => {
            currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
            loadGoals();
        };

        document.getElementById('nextMonth').onclick = () => {
            currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
            loadGoals();
        };

        loadGoals();
    </script>
</body>
</html>
