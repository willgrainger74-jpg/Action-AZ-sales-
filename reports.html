<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Data - Action Plumbing</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="p-4" style="max-width: 1400px; margin: 0 auto;">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-3xl font-bold text-blue-900">üìä Team Data</h1>
            <a href="index.html" class="px-4 py-2 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-700">‚Üê Back to Dashboard</a>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
            <div class="flex items-center justify-between mb-4">
                <button id="prevMonth" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">‚Üê Previous</button>
                <h2 id="monthYear" class="text-2xl font-bold text-blue-900"></h2>
                <button id="nextMonth" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">Next ‚Üí</button>
            </div>

            <!-- Team Goals Section -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg border-2 border-purple-300">
                <div>
                    <h3 class="font-bold text-purple-900 mb-2">üéØ Team Monthly Goal</h3>
                    <input id="teamMonthlyGoalInput" type="number" placeholder="Set goal ($)" class="w-full px-3 py-2 border-2 border-purple-300 rounded-lg mb-2 font-bold text-xl" />
                    <p id="teamMonthlyGoal" class="text-3xl font-bold text-purple-900">$0</p>
                    <div id="teamMonthlyProgress" class="mt-2"></div>
                </div>
                <div>
                    <h3 class="font-bold text-indigo-900 mb-2">üìà Monthly Forecast</h3>
                    <p id="teamForecast" class="text-3xl font-bold text-indigo-900">$0</p>
                    <p id="forecastNote" class="text-xs text-gray-600 mt-1">Based on current pace</p>
                </div>
                <div>
                    <h3 class="font-bold text-blue-900 mb-2">üèÜ Team Yearly Goal</h3>
                    <input id="teamYearlyGoalInput" type="number" placeholder="Set yearly goal ($)" class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg mb-2 font-bold text-xl" />
                    <p id="teamYearlyGoal" class="text-3xl font-bold text-blue-900">$0</p>
                    <div id="teamYearlyProgress" class="mt-2"></div>
                </div>
            </div>

            <!-- Performance Metrics Grid -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="p-4 bg-blue-50 rounded-lg border-2 border-blue-300">
                    <p class="text-sm font-bold text-blue-700">Closing Rate</p>
                    <p id="closingRate" class="text-3xl font-bold text-blue-900">0%</p>
                    <p id="closingDetails" class="text-xs text-gray-600">0 / 0 calls</p>
                </div>
                <div class="p-4 bg-green-50 rounded-lg border-2 border-green-300">
                    <p class="text-sm font-bold text-green-700">Call Average</p>
                    <p id="callAverage" class="text-3xl font-bold text-green-900">$0</p>
                    <p class="text-xs text-gray-600">per sale</p>
                </div>
                <div class="p-4 bg-purple-50 rounded-lg border-2 border-purple-300">
                    <p class="text-sm font-bold text-purple-700">Review Rate</p>
                    <p id="reviewRate" class="text-3xl font-bold text-purple-900">0%</p>
                    <p id="reviewDetails" class="text-xs text-gray-600">0 reviews</p>
                </div>
                <div class="p-4 bg-orange-50 rounded-lg border-2 border-orange-300">
                    <p class="text-sm font-bold text-orange-700">Turnover Rate</p>
                    <p id="turnoverRate" class="text-3xl font-bold text-orange-900">0%</p>
                    <p id="turnoverDetails" class="text-xs text-gray-600">0 / 0</p>
                </div>
                <div class="p-4 bg-pink-50 rounded-lg border-2 border-pink-300">
                    <p class="text-sm font-bold text-pink-700">Restoration Leads</p>
                    <p id="restorationLeads" class="text-3xl font-bold text-pink-900">0</p>
                    <p class="text-xs text-gray-600">this month</p>
                </div>
                <div class="p-4 bg-yellow-50 rounded-lg border-2 border-yellow-300">
                    <p class="text-sm font-bold text-yellow-700">Membership Plans Sold</p>
                    <p id="plansSold" class="text-3xl font-bold text-yellow-900">0</p>
                    <p class="text-xs text-gray-600">maintenance plans</p>
                </div>
                <div class="p-4 bg-teal-50 rounded-lg border-2 border-teal-300">
                    <p class="text-sm font-bold text-teal-700">Membership Rate</p>
                    <p id="membershipRate" class="text-3xl font-bold text-teal-900">0%</p>
                    <p class="text-xs text-gray-600">of sales</p>
                </div>
                <div class="p-4 bg-red-50 rounded-lg border-2 border-red-300">
                    <p class="text-sm font-bold text-red-700">Upsell Rate</p>
                    <p id="upsellRate" class="text-3xl font-bold text-red-900">0%</p>
                    <p id="upsellDetails" class="text-xs text-gray-600">0 upsells</p>
                </div>
                <div class="p-4 bg-cyan-50 rounded-lg border-2 border-cyan-300">
                    <p class="text-sm font-bold text-cyan-700">Total Revenue</p>
                    <p id="totalRevenue" class="text-3xl font-bold text-cyan-900">$0</p>
                    <p id="revenueDetails" class="text-xs text-gray-600">0 sales</p>
                </div>
                <div class="p-4 bg-orange-50 rounded-lg border-2 border-orange-300">
                    <p class="text-sm font-bold text-orange-700">Estimates Left</p>
                    <p id="estimatesLeft" class="text-3xl font-bold text-orange-900">0</p>
                    <p id="estimateValue" class="text-xs text-gray-600">$0 potential</p>
                </div>
                <div class="p-4 bg-lime-50 rounded-lg border-2 border-lime-300">
                    <p class="text-sm font-bold text-lime-700">üö™ 3 Door Knocks</p>
                    <p id="doorKnocks" class="text-3xl font-bold text-lime-900">0</p>
                    <p id="doorKnocksRate" class="text-xs text-gray-600">0% conversion</p>
                </div>
                <div class="p-4 bg-indigo-50 rounded-lg border-2 border-indigo-300">
                    <p class="text-sm font-bold text-indigo-700">Total Calls</p>
                    <p id="totalCalls" class="text-3xl font-bold text-indigo-900">0</p>
                    <p class="text-xs text-gray-600">this month</p>
                </div>
            </div>

            <!-- Turnover Stats Section -->
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-lg border-2 border-purple-300 mb-6">
                <h3 class="text-xl font-bold text-purple-900 mb-4">üîÑ Turnover Performance</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg border-2 border-purple-300">
                        <p class="text-sm font-bold text-purple-700">Revenue from Turnovers</p>
                        <p id="turnoverRevenue" class="text-4xl font-bold text-purple-900">$0</p>
                        <p id="turnoverRevenuePercent" class="text-xs text-gray-600">0% of total revenue</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg border-2 border-pink-300">
                        <p class="text-sm font-bold text-pink-700">Jobs Closed from Turnovers</p>
                        <p id="turnoverJobs" class="text-4xl font-bold text-pink-900">0</p>
                        <p id="turnoverJobsPercent" class="text-xs text-gray-600">0% of total jobs</p>
                    </div>
                </div>

                <h4 class="text-lg font-bold text-gray-800 mb-3">Top Turnover Givers (Most Leads Given Away)</h4>
                <div id="turnoverLeaderboard" class="space-y-2"></div>
            </div>

            <!-- Trade Analysis Section -->
            <div class="bg-gradient-to-r from-blue-50 to-cyan-50 p-6 rounded-lg border-2 border-blue-300 mb-6">
                <h3 class="text-xl font-bold text-blue-900 mb-4">üîß Trade Analysis</h3>
                
                <!-- Jobs Sold by Trade -->
                <div class="mb-6">
                    <h4 class="text-lg font-bold text-gray-800 mb-3">Jobs Sold by Trade</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Plumbing -->
                        <div class="bg-white p-4 rounded-lg border-2 border-blue-300">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-blue-700">üîß Plumbing</span>
                                <span class="text-2xl font-bold text-blue-900" id="plumbingJobs">0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
                                <div id="plumbingBar" class="bg-blue-500 h-full rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-600">
                                <span id="plumbingPercent">0%</span>
                                <span id="plumbingRevenue">$0</span>
                            </div>
                        </div>

                        <!-- HVAC -->
                        <div class="bg-white p-4 rounded-lg border-2 border-red-300">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-red-700">üå°Ô∏è HVAC</span>
                                <span class="text-2xl font-bold text-red-900" id="hvacJobs">0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
                                <div id="hvacBar" class="bg-red-500 h-full rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-600">
                                <span id="hvacPercent">0%</span>
                                <span id="hvacRevenue">$0</span>
                            </div>
                        </div>

                        <!-- Electrical -->
                        <div class="bg-white p-4 rounded-lg border-2 border-yellow-300">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-yellow-700">‚ö° Electrical</span>
                                <span class="text-2xl font-bold text-yellow-900" id="electricalJobs">0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
                                <div id="electricalBar" class="bg-yellow-500 h-full rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-600">
                                <span id="electricalPercent">0%</span>
                                <span id="electricalRevenue">$0</span>
                            </div>
                        </div>

                        <!-- Cameras -->
                        <div class="bg-white p-4 rounded-lg border-2 border-purple-300">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-purple-700">üìπ Cameras</span>
                                <span class="text-2xl font-bold text-purple-900" id="camerasJobs">0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
                                <div id="camerasBar" class="bg-purple-500 h-full rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-600">
                                <span id="camerasPercent">0%</span>
                                <span id="camerasRevenue">$0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Money Owed by Trade -->
                <div>
                    <h4 class="text-lg font-bold text-gray-800 mb-3">üí∞ Money Owed by Trade</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Plumbing Owed -->
                        <div class="bg-white p-4 rounded-lg border-2 border-blue-300">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-blue-700">üîß Plumbing</span>
                                <span class="text-2xl font-bold text-blue-900" id="plumbingOwed">$0</span>
                            </div>
                            <p class="text-xs text-gray-600 mt-1" id="plumbingOwedJobs">0 jobs outstanding</p>
                        </div>

                        <!-- HVAC Owed -->
                        <div class="bg-white p-4 rounded-lg border-2 border-red-300">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-red-700">üå°Ô∏è HVAC</span>
                                <span class="text-2xl font-bold text-red-900" id="hvacOwed">$0</span>
                            </div>
                            <p class="text-xs text-gray-600 mt-1" id="hvacOwedJobs">0 jobs outstanding</p>
                        </div>

                        <!-- Electrical Owed -->
                        <div class="bg-white p-4 rounded-lg border-2 border-yellow-300">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-yellow-700">‚ö° Electrical</span>
                                <span class="text-2xl font-bold text-yellow-900" id="electricalOwed">$0</span>
                            </div>
                            <p class="text-xs text-gray-600 mt-1" id="electricalOwedJobs">0 jobs outstanding</p>
                        </div>

                        <!-- Cameras Owed -->
                        <div class="bg-white p-4 rounded-lg border-2 border-purple-300">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-purple-700">üìπ Cameras</span>
                                <span class="text-2xl font-bold text-purple-900" id="camerasOwed">$0</span>
                            </div>
                            <p class="text-xs text-gray-600 mt-1" id="camerasOwedJobs">0 jobs outstanding</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Objection Breakdown -->
            <div class="bg-gradient-to-r from-red-50 to-orange-50 p-6 rounded-lg border-2 border-red-300 mb-6">
                <h3 class="text-xl font-bold text-red-900 mb-4">üö´ Objection Breakdown</h3>
                <div id="objectionsChart" class="space-y-3"></div>
            </div>
        </div>

        <!-- Monthly Leaderboard -->
        <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-6 rounded-lg shadow-lg border-2 border-green-400 mb-6">
            <h2 class="text-2xl font-bold mb-4 text-green-900">üèÖ Monthly Leaderboard</h2>
            <div id="leaderboard" class="space-y-3"></div>
        </div>

        <!-- Yearly Contributions Section -->
        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-6 rounded-lg shadow-lg border-2 border-blue-400">
            <h2 class="text-2xl font-bold mb-4 text-blue-900">üèÜ Yearly Team Contributions - <span id="yearDisplay"></span></h2>
            <div id="yearlyContributions" class="space-y-3"></div>
        </div>
    </div>

    <script>
        firebase.initializeApp({
    apiKey: "AIzaSyC8VwTY2i3kS41iy7FI_3ijCOFLV6LIwoA",
    authDomain: "action-az.firebaseapp.com",
    projectId: "action-az",
    storageBucket: "action-az.firebasestorage.app",
    messagingSenderId: "40939226263",
    appId: "1:40939226263:web:4cfc491a1e8008e86f55d2"
});

        const db = firebase.database();
        let currentDate = new Date();
        let people = [];
        let logs = {};
        let mGoals = {};
        let tmGoal = 0;
        let tyGoal = 0;
        let currentMonthKey = '';
        let currentYearKey = '';

        db.ref('salespeople').on('value', snapshot => {
            const data = snapshot.val();
            people = data ? Object.keys(data).map(k => ({ id: k, name: data[k].name })) : [];
            renderAll();
        });

        db.ref('callLogs').on('value', snapshot => {
            logs = snapshot.val() || {};
            renderAll();
        });

        db.ref('monthlyGoals').on('value', snapshot => {
            mGoals = snapshot.val() || {};
            renderAll();
        });

        const dk = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        const mk = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        const yk = d => `${d.getFullYear()}`;

        function loadTeamGoals() {
            currentMonthKey = mk(currentDate);
            currentYearKey = yk(currentDate);

            db.ref(`teamMonthlyGoals/${currentMonthKey}`).once('value', snapshot => {
                tmGoal = snapshot.val() || 0;
                document.getElementById('teamMonthlyGoalInput').value = tmGoal || '';
                renderAll();
            });

            db.ref(`teamYearlyGoals/${currentYearKey}`).once('value', snapshot => {
                tyGoal = snapshot.val() || 0;
                document.getElementById('teamYearlyGoalInput').value = tyGoal || '';
                renderAll();
            });
        }

        document.getElementById('teamMonthlyGoalInput').onchange = (e) => {
            const val = parseFloat(e.target.value) || 0;
            db.ref(`teamMonthlyGoals/${currentMonthKey}`).set(val);
            tmGoal = val;
            renderAll();
        };

        document.getElementById('teamYearlyGoalInput').onchange = (e) => {
            const val = parseFloat(e.target.value) || 0;
            db.ref(`teamYearlyGoals/${currentYearKey}`).set(val);
            tyGoal = val;
            renderAll();
        };

        function getMDates(date) {
            const y = date.getFullYear();
            const m = date.getMonth();
            const arr = [];
            const last = new Date(y, m+1, 0).getDate();
            for (let day = 1; day <= last; day++) arr.push(new Date(y, m, day));
            return arr;
        }

        function getYDates(year) {
            const arr = [];
            for (let m = 0; m < 12; m++) {
                arr.push(...getMDates(new Date(year, m, 1)));
            }
            return arr;
        }

        function getCalls(pid, d) {
            const key = `${pid}_${dk(d)}`;
            const l = logs[key];
            if (!l) return [];
            return Object.values(l);
        }

        function calcTeam(dates) {
            const t = {
                totalCalls: 0, callsSold: 0, amountSold: 0, moneyOwed: 0,
                reviewsCompleted: 0, turnoversAttempted: 0, turnoversAccepted: 0,
                restorationLeads: 0, plansSold: 0, upsellsCompleted: 0,
                estimatesLeft: 0, estimateValue: 0, doorKnocks: 0, doorKnocksSold: 0,
                objections: {},
                turnoverRevenue: 0, turnoverJobs: 0,
                turnoverGivers: {},
                trades: {
                    plumbing: { jobs: 0, revenue: 0, owed: 0, owedJobs: 0 },
                    hvac: { jobs: 0, revenue: 0, owed: 0, owedJobs: 0 },
                    electrical: { jobs: 0, revenue: 0, owed: 0, owedJobs: 0 },
                    cameras: { jobs: 0, revenue: 0, owed: 0, owedJobs: 0 }
                }
            };
            people.forEach(p => {
                dates.forEach(d => {
                    const calls = getCalls(p.id, d);
                    calls.forEach(c => {
                        t.totalCalls++;
                        if (c.jobSold) {
                            t.callsSold++;
                            t.amountSold += parseFloat(c.amountSold) || 0;
                            if (c.threeDoorKnocks) t.doorKnocksSold++;
                            
                            // Track turnover revenue
                            if (c.soldFromTurnover && c.turnoverFrom) {
                                t.turnoverRevenue += parseFloat(c.amountSold) || 0;
                                t.turnoverJobs++;
                                // Track who gave the turnover
                                if (!t.turnoverGivers[c.turnoverFrom]) {
                                    t.turnoverGivers[c.turnoverFrom] = { count: 0, revenue: 0 };
                                }
                                t.turnoverGivers[c.turnoverFrom].count++;
                                t.turnoverGivers[c.turnoverFrom].revenue += parseFloat(c.amountSold) || 0;
                            }
                            
                            // Track by trade
                            const revenue = parseFloat(c.amountSold) || 0;
                            if (c.tradePlumbing) {
                                t.trades.plumbing.jobs++;
                                t.trades.plumbing.revenue += revenue;
                            }
                            if (c.tradeHVAC) {
                                t.trades.hvac.jobs++;
                                t.trades.hvac.revenue += revenue;
                            }
                            if (c.tradeElectrical) {
                                t.trades.electrical.jobs++;
                                t.trades.electrical.revenue += revenue;
                            }
                            if (c.tradeCameras) {
                                t.trades.cameras.jobs++;
                                t.trades.cameras.revenue += revenue;
                            }
                        }
                        
                        // Track money owed by trade
                        const owed = parseFloat(c.moneyOwed) || 0;
                        if (owed > 0) {
                            t.moneyOwed += owed;
                            if (c.tradePlumbing) {
                                t.trades.plumbing.owed += owed;
                                t.trades.plumbing.owedJobs++;
                            }
                            if (c.tradeHVAC) {
                                t.trades.hvac.owed += owed;
                                t.trades.hvac.owedJobs++;
                            }
                            if (c.tradeElectrical) {
                                t.trades.electrical.owed += owed;
                                t.trades.electrical.owedJobs++;
                            }
                            if (c.tradeCameras) {
                                t.trades.cameras.owed += owed;
                                t.trades.cameras.owedJobs++;
                            }
                        }
                        
                        if (c.reviewCompleted) t.reviewsCompleted++;
                        if (c.turnoverAttempted) t.turnoversAttempted++;
                        if (c.turnoverAccepted) t.turnoversAccepted++;
                        if (c.restorationLead) t.restorationLeads++;
                        if (c.membershipPlanSold) t.plansSold++;
                        if (c.upsellCompleted) t.upsellsCompleted++;
                        if (c.leftEstimate) {
                            t.estimatesLeft++;
                            t.estimateValue += parseFloat(c.estimateAmount) || 0;
                        }
                        if (c.threeDoorKnocks) t.doorKnocks++;
                        if (c.objection) {
                            t.objections[c.objection] = (t.objections[c.objection] || 0) + 1;
                        }
                    });
                });
            });
            return t;
        }

        function calcPerson(pid, dates) {
            const t = {
                totalCalls: 0, callsSold: 0, amountSold: 0
            };
            dates.forEach(d => {
                const calls = getCalls(pid, d);
                calls.forEach(c => {
                    t.totalCalls++;
                    if (c.jobSold) {
                        t.callsSold++;
                        t.amountSold += parseFloat(c.amountSold) || 0;
                    }
                });
            });
            return t;
        }

        function renderAll() {
            const dates = getMDates(currentDate);
            const yearDates = getYDates(currentDate.getFullYear());
            const stats = calcTeam(dates);
            const yearStats = calcTeam(yearDates);

            document.getElementById('monthYear').textContent = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            document.getElementById('yearDisplay').textContent = currentDate.getFullYear();

            // Team Goals
            document.getElementById('teamMonthlyGoal').textContent = tmGoal > 0 ? `$${tmGoal.toLocaleString()}` : 'Not set';
            if (tmGoal > 0) {
                const progress = (stats.amountSold / tmGoal) * 100;
                document.getElementById('teamMonthlyProgress').innerHTML = `
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                        <div class="${progress >= 100 ? 'bg-green-600' : progress >= 50 ? 'bg-yellow-500' : 'bg-red-500'} h-full rounded-full" style="width: ${Math.min(progress, 100)}%"></div>
                    </div>
                    <p class="text-xs mt-1">${progress.toFixed(1)}% ‚Ä¢ $${stats.amountSold.toLocaleString()} / $${tmGoal.toLocaleString()}</p>
                `;
            } else {
                document.getElementById('teamMonthlyProgress').innerHTML = '';
            }

            // Forecast
            const today = new Date();
            const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            const daysPassed = currentDate.getMonth() === today.getMonth() && currentDate.getFullYear() === today.getFullYear() ? today.getDate() : daysInMonth;
            const dailyAvg = daysPassed > 0 ? stats.amountSold / daysPassed : 0;
            const forecast = dailyAvg * daysInMonth;
            document.getElementById('teamForecast').textContent = `$${Math.round(forecast).toLocaleString()}`;
            document.getElementById('forecastNote').textContent = `Based on $${Math.round(dailyAvg).toLocaleString()}/day average`;

            // Yearly Goal
            document.getElementById('teamYearlyGoal').textContent = tyGoal > 0 ? `$${tyGoal.toLocaleString()}` : 'Not set';
            if (tyGoal > 0) {
                const progress = (yearStats.amountSold / tyGoal) * 100;
                document.getElementById('teamYearlyProgress').innerHTML = `
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                        <div class="${progress >= 100 ? 'bg-green-600' : progress >= 50 ? 'bg-yellow-500' : 'bg-red-500'} h-full rounded-full" style="width: ${Math.min(progress, 100)}%"></div>
                    </div>
                    <p class="text-xs mt-1">${progress.toFixed(1)}% ‚Ä¢ $${yearStats.amountSold.toLocaleString()} / $${tyGoal.toLocaleString()}</p>
                `;
            } else {
                document.getElementById('teamYearlyProgress').innerHTML = '';
            }

            // Performance Metrics
            const closingRate = stats.totalCalls > 0 ? ((stats.callsSold / stats.totalCalls) * 100).toFixed(1) : 0;
            document.getElementById('closingRate').textContent = `${closingRate}%`;
            document.getElementById('closingDetails').textContent = `${stats.callsSold} / ${stats.totalCalls} calls`;

            const callAvg = stats.callsSold > 0 ? (stats.amountSold / stats.callsSold).toFixed(0) : 0;
            document.getElementById('callAverage').textContent = `$${callAvg}`;

            const reviewRate = stats.totalCalls > 0 ? ((stats.reviewsCompleted / stats.totalCalls) * 100).toFixed(1) : 0;
            document.getElementById('reviewRate').textContent = `${reviewRate}%`;
            document.getElementById('reviewDetails').textContent = `${stats.reviewsCompleted} reviews`;

            const turnoverRate = stats.turnoversAttempted > 0 ? ((stats.turnoversAccepted / stats.turnoversAttempted) * 100).toFixed(1) : 0;
            document.getElementById('turnoverRate').textContent = `${turnoverRate}%`;
            document.getElementById('turnoverDetails').textContent = `${stats.turnoversAccepted} / ${stats.turnoversAttempted}`;

            document.getElementById('restorationLeads').textContent = stats.restorationLeads;
            document.getElementById('plansSold').textContent = stats.plansSold;

            const membershipRate = stats.callsSold > 0 ? ((stats.plansSold / stats.callsSold) * 100).toFixed(1) : 0;
            document.getElementById('membershipRate').textContent = `${membershipRate}%`;

            const upsellRate = stats.callsSold > 0 ? ((stats.upsellsCompleted / stats.callsSold) * 100).toFixed(1) : 0;
            document.getElementById('upsellRate').textContent = `${upsellRate}%`;
            document.getElementById('upsellDetails').textContent = `${stats.upsellsCompleted} upsells`;

            document.getElementById('totalRevenue').textContent = `$${stats.amountSold.toLocaleString()}`;
            document.getElementById('revenueDetails').textContent = `${stats.callsSold} sales`;

            document.getElementById('estimatesLeft').textContent = stats.estimatesLeft;
            document.getElementById('estimateValue').textContent = `$${stats.estimateValue.toLocaleString()} potential`;

            document.getElementById('doorKnocks').textContent = stats.doorKnocks;
            const doorKnocksRate = stats.doorKnocks > 0 ? ((stats.doorKnocksSold / stats.doorKnocks) * 100).toFixed(1) : 0;
            document.getElementById('doorKnocksRate').textContent = `${doorKnocksRate}% conversion`;

            document.getElementById('totalCalls').textContent = stats.totalCalls;

            // Turnover Stats
            document.getElementById('turnoverRevenue').textContent = `$${stats.turnoverRevenue.toLocaleString()}`;
            const turnoverRevenuePercent = stats.amountSold > 0 ? ((stats.turnoverRevenue / stats.amountSold) * 100).toFixed(1) : 0;
            document.getElementById('turnoverRevenuePercent').textContent = `${turnoverRevenuePercent}% of total revenue`;

            document.getElementById('turnoverJobs').textContent = stats.turnoverJobs;
            const turnoverJobsPercent = stats.callsSold > 0 ? ((stats.turnoverJobs / stats.callsSold) * 100).toFixed(1) : 0;
            document.getElementById('turnoverJobsPercent').textContent = `${turnoverJobsPercent}% of total jobs`;

            // Turnover Leaderboard (who gave away most leads)
            const turnoverArray = Object.entries(stats.turnoverGivers).map(([id, data]) => {
                const person = people.find(p => p.id === id);
                return { id, name: person ? person.name : 'Unknown', ...data };
            }).sort((a, b) => b.count - a.count);

            document.getElementById('turnoverLeaderboard').innerHTML = turnoverArray.length > 0 ? turnoverArray.map((person, idx) => `
                <div class="bg-white p-3 rounded-lg border-2 ${idx === 0 ? 'border-purple-400' : 'border-gray-300'}">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${idx + 1}.</span>
                            <div>
                                <p class="font-bold">${person.name}</p>
                                <p class="text-xs text-gray-600">${person.count} leads given ‚Ä¢ $${person.revenue.toLocaleString()} closed</p>
                            </div>
                        </div>
                        ${idx === 0 ? '<span class="text-2xl">üëë</span>' : ''}
                    </div>
                </div>
            `).join('') : '<p class="text-center text-gray-500">No turnovers recorded this month</p>';

            // Trade Analysis
            const totalTradeJobs = stats.trades.plumbing.jobs + stats.trades.hvac.jobs + 
                                   stats.trades.electrical.jobs + stats.trades.cameras.jobs;
            
            // Plumbing
            const plumbingPercent = totalTradeJobs > 0 ? (stats.trades.plumbing.jobs / totalTradeJobs * 100).toFixed(1) : 0;
            document.getElementById('plumbingJobs').textContent = stats.trades.plumbing.jobs;
            document.getElementById('plumbingBar').style.width = `${plumbingPercent}%`;
            document.getElementById('plumbingPercent').textContent = `${plumbingPercent}%`;
            document.getElementById('plumbingRevenue').textContent = `$${stats.trades.plumbing.revenue.toLocaleString()}`;
            document.getElementById('plumbingOwed').textContent = `$${stats.trades.plumbing.owed.toLocaleString()}`;
            document.getElementById('plumbingOwedJobs').textContent = `${stats.trades.plumbing.owedJobs} jobs outstanding`;

            // HVAC
            const hvacPercent = totalTradeJobs > 0 ? (stats.trades.hvac.jobs / totalTradeJobs * 100).toFixed(1) : 0;
            document.getElementById('hvacJobs').textContent = stats.trades.hvac.jobs;
            document.getElementById('hvacBar').style.width = `${hvacPercent}%`;
            document.getElementById('hvacPercent').textContent = `${hvacPercent}%`;
            document.getElementById('hvacRevenue').textContent = `$${stats.trades.hvac.revenue.toLocaleString()}`;
            document.getElementById('hvacOwed').textContent = `$${stats.trades.hvac.owed.toLocaleString()}`;
            document.getElementById('hvacOwedJobs').textContent = `${stats.trades.hvac.owedJobs} jobs outstanding`;

            // Electrical
            const electricalPercent = totalTradeJobs > 0 ? (stats.trades.electrical.jobs / totalTradeJobs * 100).toFixed(1) : 0;
            document.getElementById('electricalJobs').textContent = stats.trades.electrical.jobs;
            document.getElementById('electricalBar').style.width = `${electricalPercent}%`;
            document.getElementById('electricalPercent').textContent = `${electricalPercent}%`;
            document.getElementById('electricalRevenue').textContent = `$${stats.trades.electrical.revenue.toLocaleString()}`;
            document.getElementById('electricalOwed').textContent = `$${stats.trades.electrical.owed.toLocaleString()}`;
            document.getElementById('electricalOwedJobs').textContent = `${stats.trades.electrical.owedJobs} jobs outstanding`;

            // Cameras
            const camerasPercent = totalTradeJobs > 0 ? (stats.trades.cameras.jobs / totalTradeJobs * 100).toFixed(1) : 0;
            document.getElementById('camerasJobs').textContent = stats.trades.cameras.jobs;
            document.getElementById('camerasBar').style.width = `${camerasPercent}%`;
            document.getElementById('camerasPercent').textContent = `${camerasPercent}%`;
            document.getElementById('camerasRevenue').textContent = `$${stats.trades.cameras.revenue.toLocaleString()}`;
            document.getElementById('camerasOwed').textContent = `$${stats.trades.cameras.owed.toLocaleString()}`;
            document.getElementById('camerasOwedJobs').textContent = `${stats.trades.cameras.owedJobs} jobs outstanding`;

            // Objections
            const objectionLabels = {
                'price': 'üí∞ Price too high',
                'think': 'ü§î Need to think',
                'spouse': 'üíë Spouse approval',
                'someone': 'üë∑ Already have someone',
                'quotes': 'üìã Multiple quotes',
                'timing': '‚è∞ Not now',
                'trust': '‚ö†Ô∏è Trust/Bad Reviews'
            };
            const totalObjections = Object.values(stats.objections).reduce((sum, v) => sum + v, 0);
            const objectionsHTML = totalObjections > 0 ? Object.entries(stats.objections)
                .sort((a, b) => b[1] - a[1])
                .map(([key, count]) => {
                    const pct = ((count / totalObjections) * 100).toFixed(1);
                    return `
                        <div class="bg-white p-3 rounded-lg border">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold">${objectionLabels[key] || key}</span>
                                <span class="text-xl font-bold text-red-900">${count}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="bg-red-500 h-full rounded-full" style="width: ${pct}%"></div>
                            </div>
                            <p class="text-xs text-gray-600 mt-1">${pct}% of all objections</p>
                        </div>
                    `;
                }).join('') : '<p class="text-center text-gray-500">No objections recorded this month üéâ</p>';
            document.getElementById('objectionsChart').innerHTML = objectionsHTML;

            // Leaderboard
            renderLeaderboard(dates);

            // Yearly Contributions
            renderYearlyContributions(yearDates);
        }

        function renderLeaderboard(dates) {
            const allStats = people.map(p => {
                const stats = calcPerson(p.id, dates);
                const goal = mGoals[`${p.id}_${mk(currentDate)}`] || 0;
                const goalProgress = goal > 0 ? (stats.amountSold / goal) * 100 : 0;
                return { ...p, ...stats, goal, goalProgress };
            }).sort((a, b) => b.amountSold - a.amountSold);

            const medals = ['ü•á', 'ü•à', 'ü•â'];
            const titles = ['üëë Month Leader', '‚≠ê Runner Up', 'üéØ Bronze'];

            document.getElementById('leaderboard').innerHTML = allStats.map((person, idx) => {
                const closeRate = person.totalCalls > 0 ? (person.callsSold / person.totalCalls) * 100 : 0;
                return `
                    <div class="p-4 rounded-lg border-2 ${
                        idx === 0 ? 'bg-green-100 border-green-400' :
                        idx === 1 ? 'bg-gray-100 border-gray-400' :
                        idx === 2 ? 'bg-orange-100 border-orange-400' :
                        'bg-white border-gray-300'
                    }">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">${idx < 3 ? medals[idx] : `#${idx + 1}`}</span>
                                <div>
                                    <p class="font-bold text-lg">${person.name}</p>
                                    ${idx < 3 ? `<p class="text-xs text-gray-600">${titles[idx]}</p>` : ''}
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-600">Month Total</p>
                                <p class="font-bold text-xl">$${person.amountSold.toLocaleString()}</p>
                                <p class="text-xs text-gray-600">${person.callsSold} sales ‚Ä¢ ${closeRate.toFixed(1)}% close</p>
                            </div>
                        </div>
                        ${person.goal > 0 ? `
                            <div class="mt-2">
                                <div class="flex justify-between text-xs mb-1">
                                    <span>Goal Progress:</span>
                                    <span class="font-bold">${person.goalProgress.toFixed(0)}% of $${person.goal.toLocaleString()}</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="${
                                        person.goalProgress >= 100 ? 'bg-green-600' :
                                        person.goalProgress >= 50 ? 'bg-yellow-500' : 'bg-red-500'
                                    } h-full rounded-full" style="width: ${Math.min(person.goalProgress, 100)}%"></div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderYearlyContributions(dates) {
            const yearTotal = calcTeam(dates).amountSold;
            
            const allStats = people.map(p => {
                const stats = calcPerson(p.id, dates);
                const contribution = yearTotal > 0 ? (stats.amountSold / yearTotal) * 100 : 0;
                const teamGoalContribution = tyGoal > 0 ? (stats.amountSold / tyGoal) * 100 : 0;
                return { ...p, ...stats, contribution, teamGoalContribution };
            }).sort((a, b) => b.amountSold - a.amountSold);

            document.getElementById('yearlyContributions').innerHTML = allStats.map((person, idx) => `
                <div class="p-4 bg-white rounded-lg border-2 border-blue-300">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl font-bold text-gray-600">#${idx + 1}</span>
                            <div>
                                <p class="font-bold text-lg">${person.name}</p>
                                <p class="text-sm text-gray-600">${person.callsSold} sales ‚Ä¢ $${person.amountSold.toLocaleString()}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-blue-900">${person.contribution.toFixed(1)}%</p>
                            <p class="text-xs text-gray-600">of team total</p>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="flex justify-between text-xs mb-1">
                            <span>Contribution to Team Total:</span>
                            <span class="font-bold">${person.contribution.toFixed(1)}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="bg-blue-500 h-full rounded-full" style="width: ${Math.min(person.contribution, 100)}%"></div>
                        </div>
                    </div>
                    ${tyGoal > 0 ? `
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span>Contribution to Yearly Goal ($${tyGoal.toLocaleString()}):</span>
                                <span class="font-bold">${person.teamGoalContribution.toFixed(1)}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="${
                                    person.teamGoalContribution >= 10 ? 'bg-green-500' :
                                    person.teamGoalContribution >= 5 ? 'bg-yellow-500' : 'bg-red-500'
                                } h-full rounded-full" style="width: ${Math.min(person.teamGoalContribution, 100)}%"></div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        document.getElementById('prevMonth').onclick = () => {
            currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
            loadTeamGoals();
        };

        document.getElementById('nextMonth').onclick = () => {
            currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
            loadTeamGoals();
        };

        loadTeamGoals();
    </script>
</body>
</html>
